name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest respx httpx pre-commit
        
    - name: Setup test environment
      run: |
        mkdir -p data/staging data/output logs
        mkdir -p Tourplaene
        # Dummy CSV für Tests erstellen
        echo "Kunde;Adresse" > Tourplaene/dummy.csv
        echo "Test;Test Straße 1" >> Tourplaene/dummy.csv
        
    - name: Build orig integrity (optional)
      run: |
        python -c "
        try:
            from tools.orig_integrity import build
            build()
            print('✅ Orig integrity build successful')
        except ImportError:
            print('⚠️  Orig integrity not available, skipping')
        except Exception as e:
            print(f'⚠️  Orig integrity build failed: {e}')
        " || true
        
    - name: Run pre-commit hooks
      run: |
        pre-commit install
        pre-commit run --all-files || true
        
    - name: Run tests
      run: |
        pytest -v --tb=short
        
    - name: Test Docker build
      run: |
        docker build -t trafficapp-test .
        
    - name: Test Docker Compose
      run: |
        docker-compose config
        echo "✅ Docker Compose configuration valid"
        
    - name: Check file permissions
      run: |
        echo "Checking file structure..."
        ls -la
        echo "Checking Tourplaene directory..."
        ls -la Tourplaene/ || echo "Tourplaene directory not found"
        echo "Checking data directories..."
        ls -la data/ || echo "Data directory not found"
        
    - name: Test PathPolicy initialization
      run: |
        python -c "
        try:
            from fs.safefs import init_policy
            init_policy('./Tourplaene', './data/staging', './data/output', './routen')
            print('✅ PathPolicy initialization successful')
        except Exception as e:
            print(f'❌ PathPolicy initialization failed: {e}')
            exit(1)
        "
        
    - name: Test database schema
      run: |
        python -c "
        try:
            from db.schema import ensure_schema
            from db.schema_fail import ensure_fail_schema
            ensure_schema()
            ensure_fail_schema()
            print('✅ Database schema creation successful')
        except Exception as e:
            print(f'❌ Database schema creation failed: {e}')
            exit(1)
        "
