<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMO TrafficApp - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .health-card { margin-bottom: 1rem; }
        .health-ok { border-left: 4px solid #28a745; }
        .health-error { border-left: 4px solid #dc3545; }
        .health-warning { border-left: 4px solid #ffc107; }
        .latency { font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">FAMO TrafficApp</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Hauptseite</a>
                <a class="nav-link active" href="/admin.html">Admin</a>
                <a class="nav-link" href="#" id="logoutLink" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Login-Check (wird ausgeblendet wenn authentifiziert) -->
    <div id="loginRequired" style="display: none;">
        <div class="container mt-5">
            <div class="alert alert-warning">
                <h4><i class="fas fa-lock"></i> Authentifizierung erforderlich</h4>
                <p>Sie müssen sich einloggen, um auf den Admin-Bereich zuzugreifen.</p>
                <a href="/admin/login.html" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Zum Login
                </a>
            </div>
        </div>
    </div>
    
    <!-- Admin-Inhalt (wird ausgeblendet wenn nicht authentifiziert) -->
    <div id="adminContent">

    <div class="container-fluid mt-4">
        <h1><i class="fas fa-cog"></i> Admin-Bereich</h1>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mt-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab">
                    <i class="fas fa-heartbeat"></i> System/Health
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="testboard-tab" data-bs-toggle="tab" data-bs-target="#testboard" type="button" role="tab">
                    <i class="fas fa-vial"></i> Testboard (Stub)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-test-tab" data-bs-toggle="tab" data-bs-target="#ai-test" type="button" role="tab">
                    <i class="fas fa-robot"></i> AI-Test (Stub)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> Statistik
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">
                    <i class="fas fa-book"></i> Systemregeln
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#db" type="button" role="tab">
                    <i class="fas fa-database"></i> DB-Verwaltung
                </button>
            </li>
        </ul>
        
        <!-- KI-Integrationen Links (außerhalb der Tabs) -->
        <div class="mt-3 mb-3">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> KI-Integrationen</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/admin/ki-improvements" class="btn btn-outline-primary">
                            <i class="fas fa-code"></i> KI-CodeChecker
                        </a>
                        <a href="/admin/ki-kosten" class="btn btn-outline-warning">
                            <i class="fas fa-coins"></i> KI-Kosten & Modelle
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content mt-3" id="adminTabContent">
            <!-- Health Tab -->
            <div class="tab-pane fade show active" id="health" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card health-card" id="health-app-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-server"></i> App Health</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-app-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-osrm-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-route"></i> OSRM Health</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-osrm-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-db-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-database"></i> Database Health</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-db-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-osrm-sample-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-map"></i> OSRM Sample Route</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-osrm-sample-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testboard Tab -->
            <div class="tab-pane fade" id="testboard" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-vial"></i> Testboard</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>API-Endpoints testen</h6>
                            <div class="btn-group-vertical w-100" role="group">
                                <button class="btn btn-outline-primary mb-2" onclick="testEndpoint('/health/app', 'health-app-result')">
                                    <i class="fas fa-server"></i> Health App
                                </button>
                                <button class="btn btn-outline-primary mb-2" onclick="testEndpoint('/health/osrm', 'health-osrm-result')">
                                    <i class="fas fa-route"></i> Health OSRM
                                </button>
                                <button class="btn btn-outline-primary mb-2" onclick="testEndpoint('/health/db', 'health-db-result')">
                                    <i class="fas fa-database"></i> Health DB
                                </button>
                                <button class="btn btn-outline-primary mb-2" onclick="testEndpoint('/api/stats/overview', 'stats-result')">
                                    <i class="fas fa-chart-bar"></i> Stats Overview
                                </button>
                            </div>
                        </div>
                        <div id="testboard-results">
                            <h6>Test-Ergebnisse:</h6>
                            <div id="health-app-result" class="test-result mb-2"></div>
                            <div id="health-osrm-result" class="test-result mb-2"></div>
                            <div id="health-db-result" class="test-result mb-2"></div>
                            <div id="stats-result" class="test-result mb-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI-Test Tab -->
            <div class="tab-pane fade" id="ai-test" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-robot"></i> AI-Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> AI-Test-Funktionalität wird in Phase 2 implementiert.
                        </div>
                        <div class="mb-3">
                            <h6>LLM-Status</h6>
                            <div id="llm-status" class="alert alert-secondary">
                                <i class="fas fa-spinner fa-spin"></i> Lade LLM-Status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Systemregeln Tab -->
            <div class="tab-pane fade" id="rules" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h3><i class="fas fa-book"></i> Systemregeln für Routen-Aufsplittung</h3>
                        <p class="text-muted">Diese Regeln werden vom LLM und der Optimierungs-Engine verwendet.</p>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 1. Zeit-Constraints (HÖCHSTE PRIORITÄT)</h5>
                            </div>
                            <div class="card-body">
                                <h6>Hauptregel: Tour-Zeit OHNE Rückfahrt</h6>
                                <ul>
                                    <li><strong>KRITISCH:</strong> Jede Tour muss <strong>≤ <span id="time-budget-without-return">65</span> Minuten (OHNE Rückfahrt)</strong> sein!</li>
                                    <li>Berechnung: <code>Fahrzeit + Servicezeit ≤ <span id="time-budget-without-return-2">65</span> Minuten</code></li>
                                    <li>Rückfahrt zum Depot kommt <strong>DANACH</strong> und zählt <strong>NICHT</strong> in die <span id="time-budget-without-return-3">65</span> Minuten!</li>
                                    <li>Wenn eine Gruppe zu groß wäre → <strong>ERSTELLE MEHRERE SEPARATE TOUREN (A, B, C, D, E)</strong>, NICHT Unterrouten!</li>
                                </ul>
                                
                                <h6 class="mt-3">Zeitbox-Regel: Gesamtzeit INKL. Rückfahrt</h6>
                                <ul>
                                    <li>Gesamtzeit inkl. Rückfahrt darf <strong>≤ <span id="time-budget-with-return">90</span> Minuten</strong> betragen</li>
                                    <li>Dies ist eine zusätzliche Prüfung nach der Hauptregel</li>
                                </ul>
                                
                                <h6 class="mt-3">Service-Zeit pro Kunde</h6>
                                <ul>
                                    <li><strong>Standard:</strong> <span id="service-time-per-stop">2</span> Minuten pro Kunde</li>
                                    <li>Kann pro Kunde individuell angepasst werden</li>
                                    <li>Wird zur Fahrzeit addiert</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> 2. Geografische Optimierung</h5>
                            </div>
                            <div class="card-body">
                                <h6>Priorität (Reihenfolge ist wichtig!)</h6>
                                <ol>
                                    <li><strong>Zeit-Constraint ≤ <span id="time-budget-without-return-4">65</span> Min (ohne Rückfahrt)</strong> - MUSS erfüllt sein</li>
                                    <li><strong>Geografische Nähe</strong> - Gruppiere Kunden nach Entfernung zueinander</li>
                                    <li><strong>Max. Stopps pro Tour</strong> - Nur wenn Zeit-Constraint erfüllt ist!</li>
                                </ol>
                                
                                <h6 class="mt-3">Max. Stopps pro Tour</h6>
                                <ul>
                                    <li><strong>KEIN Limit</strong> - so viele Stopps wie möglich, solange Zeit-Constraint (≤ <span id="time-budget-without-return-5">65</span> Min ohne Rückfahrt) erfüllt ist!</li>
                                    <li>Wenn Zeit-Constraint nicht erfüllt → weniger Stopps pro Tour, mehr Touren erstellen!</li>
                                </ul>
                                
                                <h6 class="mt-3">Straßenbasierte Clustering</h6>
                                <ul>
                                    <li><strong>Priorität:</strong> Kunden auf derselben Straße zusammenhalten</li>
                                    <li>Beispiel: Alle "Fröbelstraße"-Stopps sollten zusammen bleiben, bevor zu "Tharandter Straße" gewechselt wird</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-warehouse"></i> 3. Depot als Start- und Endpunkt</h5>
                            </div>
                            <div class="card-body">
                                <h6>Depot-Koordinaten</h6>
                                <ul>
                                    <li><strong>FAMO Dresden:</strong> <code id="depot-coords">51.0111988, 13.7016485</code></li>
                                    <li>Alle Touren starten und enden am Depot</li>
                                    <li>Depot wird <strong>nicht</strong> als Stop in der Tour-Liste angezeigt</li>
                                </ul>
                                
                                <h6 class="mt-3">Rückfahrt-Berechnung</h6>
                                <ul>
                                    <li>Rückfahrt vom letzten Kunden zum Depot wird <strong>separat</strong> berechnet</li>
                                    <li>Zählt <strong>NICHT</strong> in die <span id="time-budget-without-return-6">65</span>-Minuten-Regel</li>
                                    <li>Wird zur finalen Gesamtzeit addiert</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-sitemap"></i> 4. Tour-Aufteilung</h5>
                            </div>
                            <div class="card-body">
                                <h6>Wenn Tour zu groß ist</h6>
                                <ul>
                                    <li><strong>NICHT:</strong> Sub-Routen (C1, C2) erstellen</li>
                                    <li><strong>SONDERN:</strong> Separate Touren (A, B, C, D, E) erstellen</li>
                                    <li>Jede separate Tour muss die <span id="time-budget-without-return-7">65</span>-Minuten-Regel erfüllen</li>
                                </ul>
                                
                                <h6 class="mt-3">Tour-Namen für separate Touren</h6>
                                <ul>
                                    <li>Format: <code>{Original-Name} Tour {Buchstabe}</code></li>
                                    <li>Beispiel: <code>W-07.00 Uhr Tour A</code>, <code>W-07.00 Uhr Tour B</code>, etc.</li>
                                    <li>Buchstaben: A, B, C, D, E, ...</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-route"></i> 5. OSRM-First Strategie</h5>
                            </div>
                            <div class="card-body">
                                <h6>Distanz- und Zeitberechnung</h6>
                                <ol>
                                    <li><strong>Priorität 1:</strong> OSRM (Open Source Routing Machine) - straßenbasierte Routen</li>
                                    <li><strong>Priorität 2:</strong> Haversine-Distanz × <span id="safety-factor">1.3</span> (Fallback für Stadtverkehr)</li>
                                    <li><strong>NICHT:</strong> Luftlinie ohne Anpassung verwenden!</li>
                                </ol>
                                
                                <h6 class="mt-3">Durchschnittsgeschwindigkeit</h6>
                                <ul>
                                    <li><strong>Stadtverkehr:</strong> <span id="speed-kmh">50</span> km/h</li>
                                </ul>
                                
                                <h6 class="mt-3">Sicherheitsfaktor für Stadtverkehr</h6>
                                <ul>
                                    <li><strong>Standard:</strong> <span id="safety-factor-2">1.3</span> (30% Aufschlag auf Luftlinie)</li>
                                    <li><strong>Berechnung:</strong> <code>Straßenentfernung = Haversine-Distanz × Sicherheitsfaktor</code></li>
                                    <li><strong>Beispiel:</strong> 10 km Luftlinie → 13 km Straßenentfernung (bei Faktor 1.3)</li>
                                    <li><strong>Zweck:</strong> Kompensiert die Differenz zwischen Luftlinie (Haversine) und tatsächlicher Straßenentfernung im Stadtverkehr</li>
                                    <li><strong>Warum nötig?</strong> In Städten sind Straßen länger als die direkte Luftlinie durch:
                                        <ul>
                                            <li>Einbahnstraßen und Verkehrsführung</li>
                                            <li>Umwege und nicht-direkte Straßenverbindungen</li>
                                            <li>Verkehrsregelungen und Ampeln</li>
                                        </ul>
                                    </li>
                                    <li><strong>Anpassung:</strong>
                                        <ul>
                                            <li><strong>1.1-1.2:</strong> Einfache Routen, direkte Verbindungen</li>
                                            <li><strong>1.3:</strong> Standard für Stadtverkehr (empfohlen)</li>
                                            <li><strong>1.4-1.5:</strong> Komplexe Stadtgebiete, viele Umwege</li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0"><i class="fas fa-compass"></i> 6. Sektor-Planung (W-Touren)</h5>
                            </div>
                            <div class="card-body">
                                <h6>Automatische Sektor-Planung</h6>
                                <ul>
                                    <li><strong>Nur für W-Touren</strong> (Tour-Name beginnt mit "W-")</li>
                                    <li>Dresden wird in 4 Sektoren aufgeteilt: <strong>Nord (N), Ost (O), Süd (S), West (W)</strong></li>
                                    <li>Stopps werden nach Himmelsrichtung (Bearing) vom Depot zugeordnet</li>
                                    <li><strong>Feste Cluster:</strong> Stopps bleiben in ihrem Sektor (keine Verschiebung zwischen Sektoren)</li>
                                </ul>
                                
                                <h6 class="mt-3">Zeitbox für W-Touren</h6>
                                <ul>
                                    <li>Start: <strong>07:00 Uhr</strong></li>
                                    <li>Hard Deadline: <strong>09:00 Uhr</strong></li>
                                    <li>Time Budget: <strong><span id="time-budget-with-return-2">90</span> Minuten</strong> (inkl. Rückfahrt)</li>
                                    <li>Aber: Hauptregel (≤ <span id="time-budget-without-return-8">65</span> Min ohne Rückfahrt) hat weiterhin Priorität!</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Editier-Formular für Systemregeln -->
                        <div class="card mt-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-edit"></i> Systemregeln bearbeiten</h5>
                            </div>
                            <div class="card-body">
                                <form id="system-rules-form">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-time-budget-without-return" class="form-label">
                                                Zeitbudget ohne Rückfahrt (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-time-budget-without-return" 
                                                   min="1" max="120" step="1" required>
                                            <small class="form-text text-muted">Hauptregel: Tour muss ≤ diesem Wert sein (ohne Rückfahrt)</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-time-budget-with-return" class="form-label">
                                                Zeitbudget mit Rückfahrt (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-time-budget-with-return" 
                                                   min="1" max="180" step="1" required>
                                            <small class="form-text text-muted">Gesamtzeit inkl. Rückfahrt</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-service-time-per-stop" class="form-label">
                                                Service-Zeit pro Stop (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-service-time-per-stop" 
                                                   min="0.5" max="10" step="0.1" required>
                                            <small class="form-text text-muted">Standard-Service-Zeit pro Kunde</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-speed-kmh" class="form-label">
                                                Durchschnittsgeschwindigkeit (km/h)
                                            </label>
                                            <input type="number" class="form-control" id="edit-speed-kmh" 
                                                   min="10" max="100" step="1" required>
                                            <small class="form-text text-muted">Für Stadtverkehr</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-safety-factor" class="form-label">
                                                Sicherheitsfaktor (Stadtverkehr)
                                            </label>
                                            <input type="number" class="form-control" id="edit-safety-factor" 
                                                   min="1.0" max="2.0" step="0.1" required>
                                            <small class="form-text text-muted">
                                                <strong>Was ist das?</strong><br>
                                                Der Sicherheitsfaktor kompensiert die Differenz zwischen Luftlinie (Haversine) und tatsächlicher Straßenentfernung im Stadtverkehr.<br>
                                                <strong>Standard: 1.3</strong> bedeutet: Luftlinie × 1.3 = geschätzte Straßenentfernung<br>
                                                <strong>Beispiel:</strong> 10 km Luftlinie → 13 km Straßenentfernung (bei Faktor 1.3)<br>
                                                <strong>Warum?</strong> In Städten sind Straßen länger als die direkte Luftlinie (Einbahnstraßen, Umwege, Verkehrsführung).<br>
                                                <strong>Anpassung:</strong> Höhere Werte (z.B. 1.5) für komplexe Stadtgebiete, niedrigere (z.B. 1.1) für einfache Routen.
                                            </small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="edit-depot-lat" class="form-label">
                                                Depot Latitude
                                            </label>
                                            <input type="number" class="form-control" id="edit-depot-lat" 
                                                   min="-90" max="90" step="0.0000001" required>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="edit-depot-lon" class="form-label">
                                                Depot Longitude
                                            </label>
                                            <input type="number" class="form-control" id="edit-depot-lon" 
                                                   min="-180" max="180" step="0.0000001" required>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Speichern
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="resetSystemRulesForm()">
                                            <i class="fas fa-undo"></i> Zurücksetzen
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                                            <i class="fas fa-redo"></i> Standard-Werte
                                        </button>
                                    </div>
                                    <div id="rules-save-message" class="mt-3"></div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle"></i> Hinweis</h6>
                            <p>Diese Regeln werden automatisch vom System angewendet. Änderungen werden in <code>config/system_rules.json</code> gespeichert.</p>
                            <p><small>Quelle: <code>config/system_rules.json</code> (wird automatisch erstellt)</small></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistik Tab -->
            <div class="tab-pane fade" id="stats" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Statistik-Details</h5>
                        <div>
                            <select id="stats-period" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                <option value="daily">Täglich</option>
                                <option value="monthly" selected>Monatlich</option>
                            </select>
                            <select id="stats-count" class="form-select form-select-sm d-inline-block ms-2" style="width: auto;">
                                <option value="7">7</option>
                                <option value="14">14</option>
                                <option value="30" selected>30</option>
                                <option value="90">90</option>
                                <option value="365">365</option>
                            </select>
                            <button class="btn btn-sm btn-primary ms-2" onclick="loadStats()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="stats-loading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin"></i> Lade Statistiken...
                        </div>
                        <div id="stats-content" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Touren</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-tours"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Stops</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-stops"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Kilometer</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-km"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="exportStats('csv')">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button class="btn btn-info" onclick="exportStats('json')">
                                    <i class="fas fa-file-code"></i> Export JSON
                                </button>
                            </div>
                        </div>
                        <div id="stats-error" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            <!-- DB-Verwaltung Tab -->
            <div class="tab-pane fade" id="db" role="tabpanel">
                <h3 class="mb-4"><i class="fas fa-database"></i> Datenbank-Verwaltung</h3>
                
                <!-- Batch Geocoding Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> Batch-Geocoding für Tourenpläne</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Laden Sie Tourenpläne hoch, lassen Sie die Adressen automatisch geocodieren und speichern Sie die Koordinaten direkt in die Datenbank.
                        </p>
                        
                        <!-- Upload-Bereich -->
                        <div class="mb-4">
                            <h6><i class="fas fa-upload"></i> Tourenpläne hochladen</h6>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" id="db-tourplan-upload" accept=".csv" multiple onchange="validateCSVFiles()">
                                <button class="btn btn-primary" type="button" onclick="uploadTourplansForGeocoding()" id="db-upload-button">
                                    <i class="fas fa-cloud-upload-alt"></i> Hochladen
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Mehrere CSV-Dateien möglich (max. 10 Dateien, je max. 50 MB). Die Adressen werden automatisch geocodiert und in die DB gespeichert.
                            </small>
                            <div id="csv-validation-message" class="mt-2" style="display: none;"></div>
                        </div>

                        <!-- Verfügbare Tourenpläne -->
                        <div class="mb-4">
                            <h6><i class="fas fa-list"></i> Verfügbare Tourenpläne</h6>
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="loadAvailableTourplans()">
                                    <i class="fas fa-sync"></i> Liste aktualisieren
                                </button>
                                <button class="btn btn-success btn-sm" onclick="geocodeAllTourplans()">
                                    <i class="fas fa-magic"></i> Alle geocodieren
                                </button>
                            </div>
                            <div id="tourplan-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle"></i> Klicken Sie auf "Liste aktualisieren" um verfügbare Tourenpläne zu laden
                                </div>
                            </div>
                        </div>

                        <!-- Geocoding Progress -->
                        <div id="geocoding-progress-container" style="display: none;">
                            <h6><i class="fas fa-tasks"></i> Geocoding-Fortschritt</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <span id="geocoding-progress-text">0 / 0</span>
                                    <span id="geocoding-progress-percent">0%</span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div id="geocoding-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                         role="progressbar" style="width: 0%">
                                    </div>
                                </div>
                            </div>
                            <div id="geocoding-status" class="alert alert-info">
                                <small>Bereit zum Starten...</small>
                            </div>
                            <div id="geocoding-results" class="mt-3" style="display: none;">
                                <h6>Ergebnisse:</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center border-success">
                                            <div class="card-body">
                                                <h3 class="text-success" id="geocoding-success-count">0</h3>
                                                <small>Erfolgreich</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-warning">
                                            <div class="card-body">
                                                <h3 class="text-warning" id="geocoding-skip-count">0</h3>
                                                <small>Übersprungen</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-danger">
                                            <div class="card-body">
                                                <h3 class="text-danger" id="geocoding-error-count">0</h3>
                                                <small>Fehler</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-info">
                                            <div class="card-body">
                                                <h3 class="text-info" id="geocoding-total-count">0</h3>
                                                <small>Gesamt</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DB-Statistiken -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Datenbank-Statistiken</h5>
                    </div>
                    <div class="card-body">
                        <div id="db-stats" class="row">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-primary" id="db-customers-count">-</h4>
                                        <small>Kunden</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-success" id="db-geocoded-count">-</h4>
                                        <small>Geocodiert</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning" id="db-missing-count">-</h4>
                                        <small>Fehlend</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info" id="db-geocode-percent">-</h4>
                                        <small>Geocoding-Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-info btn-sm" onclick="loadDBStats()">
                                <i class="fas fa-sync"></i> Statistiken aktualisieren
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ende DB-Verwaltung Tab -->
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Health-Checks laden
        async function loadHealthChecks() {
            // App Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/app');
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-app-card');
                const content = document.getElementById('health-app-content');
                
                if (data.status === 'ok') {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: OK</div>
                        <div class="mt-2"><strong>Environment:</strong> ${data.env || 'unknown'}</div>
                        <div><strong>Feature Flags:</strong></div>
                        <ul class="small">
                            <li>Stats-Box: ${data.feature_flags?.stats_box_enabled ? '✅' : '❌'}</li>
                            <li>AI-Ops: ${data.feature_flags?.ai_ops_enabled ? '✅' : '❌'}</li>
                        </ul>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    content.innerHTML = `<div class="text-danger">Status: ERROR</div>`;
                }
            } catch (e) {
                document.getElementById('health-app-card').classList.add('health-error');
                document.getElementById('health-app-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // OSRM Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/osrm').catch(err => {
                    console.warn('OSRM Health-Check fehlgeschlagen:', err);
                    return null;
                });
                
                if (!response || !response.ok) {
                    // OSRM nicht erreichbar - zeige Warnung statt Fehler
                    const card = document.getElementById('health-osrm-card');
                    const content = document.getElementById('health-osrm-content');
                    if (card && content) {
                        card.className = 'card border-warning';
                        content.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>OSRM nicht erreichbar</strong><br>
                                <small>Bitte prüfen Sie, ob Docker Desktop läuft und OSRM gestartet ist.</small>
                            </div>
                        `;
                    }
                    return;
                }
                
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-osrm-card');
                const content = document.getElementById('health-osrm-content');
                
                // Prüfe data.ok (nicht data.status)
                if (data.ok === true || data.status === 'up' || data.status === 'ok') {
                    card.classList.add('health-ok');
                    card.classList.remove('health-error', 'health-warning');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: OK</div>
                        <div class="mt-2"><strong>URL:</strong> ${data.url || 'unknown'}</div>
                        <div><strong>Status:</strong> ${data.status || 'unknown'}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    card.classList.remove('health-ok', 'health-warning');
                    const errorMsg = data.error || data.message || 'Unknown error';
                    content.innerHTML = `
                        <div class="text-danger"><i class="fas fa-times-circle"></i> Status: ERROR</div>
                        <div class="mt-2"><strong>URL:</strong> ${data.url || 'unknown'}</div>
                        <div class="mt-2"><strong>Fehler:</strong> ${errorMsg}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-osrm-card').classList.add('health-error');
                document.getElementById('health-osrm-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // DB Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/db');
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-db-card');
                const content = document.getElementById('health-db-content');
                
                if (data.status === 'online') {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: Online</div>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    content.innerHTML = `
                        <div class="text-danger"><i class="fas fa-times-circle"></i> Status: Offline</div>
                        <div class="mt-2"><strong>Error:</strong> ${data.error || 'Unknown'}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-db-card').classList.add('health-error');
                document.getElementById('health-db-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // OSRM Sample Route
            try {
                const startTime = performance.now();
                const response = await fetch('/health/osrm/sample-route').catch(err => {
                    console.warn('OSRM Sample-Route-Check fehlgeschlagen:', err);
                    return null;
                });
                
                if (!response || !response.ok) {
                    // OSRM Sample-Route nicht verfügbar - zeige Warnung statt Fehler
                    const card = document.getElementById('health-osrm-sample-card');
                    const content = document.getElementById('health-osrm-sample-content');
                    if (card && content) {
                        card.className = 'card border-warning';
                        content.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>OSRM Sample-Route nicht verfügbar</strong><br>
                                <small>OSRM-Service ist möglicherweise nicht gestartet oder nicht erreichbar.</small>
                            </div>
                        `;
                    }
                    return;
                }
                
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-osrm-sample-card');
                const content = document.getElementById('health-osrm-sample-content');
                
                if (data.ok) {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Polyline6 verfügbar</div>
                        <div class="mt-2"><strong>Polyline-Länge:</strong> ${data.polyline6_len || 0} Zeichen</div>
                        <div><strong>Status:</strong> ${data.status || 'unknown'}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-warning');
                    content.innerHTML = `
                        <div class="text-warning"><i class="fas fa-exclamation-triangle"></i> Polyline6 nicht verfügbar</div>
                        <div class="mt-2"><strong>Error:</strong> ${data.error || 'Unknown'}</div>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-osrm-sample-card').classList.add('health-error');
                document.getElementById('health-osrm-sample-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }
        }

        // Testboard: Endpoint testen
        async function testEndpoint(url, resultId) {
            const resultDiv = document.getElementById(resultId);
            if (!resultDiv) return;
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Teste...';
            resultDiv.className = 'test-result mb-2 alert alert-secondary';
            
            try {
                const startTime = performance.now();
                const response = await fetch(url);
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'test-result mb-2 alert alert-success';
                    resultDiv.innerHTML = `
                        <strong>${url}</strong> - Status: ${response.status}<br>
                        <small>Latenz: ${latency}ms</small><br>
                        <pre class="mt-2 mb-0" style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'test-result mb-2 alert alert-warning';
                    resultDiv.innerHTML = `
                        <strong>${url}</strong> - Status: ${response.status}<br>
                        <small>Latenz: ${latency}ms</small><br>
                        <pre class="mt-2 mb-0" style="font-size: 0.8em;">${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.className = 'test-result mb-2 alert alert-danger';
                resultDiv.innerHTML = `
                    <strong>${url}</strong> - Fehler<br>
                    <small>${e.message}</small>
                `;
            }
        }
        
        // LLM-Status laden
        async function loadLLMStatus() {
            const statusDiv = document.getElementById('llm-status');
            if (!statusDiv) return;
            
            try {
                // Prüfe ob LLM-Monitoring-Endpoint existiert
                const response = await fetch('/api/llm/monitoring').catch(() => null);
                if (response && response.ok) {
                    const data = await response.json();
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> LLM verfügbar<br>
                        <small><pre style="font-size: 0.8em;">${JSON.stringify(data, null, 2)}</pre></small>
                    `;
                } else {
                    statusDiv.className = 'alert alert-warning';
                    statusDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> LLM-Status-Endpoint nicht verfügbar<br>
                        <small>Endpoint: /api/llm/monitoring</small>
                    `;
                }
            } catch (e) {
                statusDiv.className = 'alert alert-secondary';
                statusDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i> LLM-Status kann nicht geladen werden<br>
                    <small>${e.message}</small>
                `;
            }
        }

        // Chart-Instanzen
        let toursChart = null;
        let stopsChart = null;
        let kmChart = null;

        // Statistiken laden
        async function loadStats() {
            const period = document.getElementById('stats-period').value;
            const count = parseInt(document.getElementById('stats-count').value);
            const loadingEl = document.getElementById('stats-loading');
            const contentEl = document.getElementById('stats-content');
            const errorEl = document.getElementById('stats-error');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            try {
                const endpoint = period === 'daily' ? '/api/stats/daily' : '/api/stats/monthly';
                const param = period === 'daily' ? 'days' : 'months';
                const response = await fetch(`${endpoint}?${param}=${count}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const stats = period === 'daily' ? data.days : data.months;

                if (!stats || stats.length === 0) {
                    throw new Error('Keine Daten verfügbar');
                }

                // Charts aktualisieren
                updateCharts(stats, period);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                loadingEl.style.display = 'none';
                errorEl.textContent = `Fehler beim Laden der Statistiken: ${e.message}`;
                errorEl.style.display = 'block';
            }
        }

        // Charts aktualisieren
        function updateCharts(stats, period) {
            const labelKey = period === 'daily' ? 'date' : 'month';
            const labels = stats.map(s => s[labelKey]).reverse();
            const toursData = stats.map(s => s.tours).reverse();
            const stopsData = stats.map(s => s.stops).reverse();
            const kmData = stats.map(s => s.km).reverse();

            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            };

            // Touren-Chart
            if (toursChart) toursChart.destroy();
            toursChart = new Chart(document.getElementById('chart-tours'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Touren',
                        data: toursData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                }
            });

            // Stops-Chart
            if (stopsChart) stopsChart.destroy();
            stopsChart = new Chart(document.getElementById('chart-stops'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stops',
                        data: stopsData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                }
            });

            // KM-Chart
            if (kmChart) kmChart.destroy();
            kmChart = new Chart(document.getElementById('chart-km'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kilometer',
                        data: kmData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                }
            });
        }

        // Export-Funktion
        function exportStats(format) {
            const period = document.getElementById('stats-period').value;
            const count = parseInt(document.getElementById('stats-count').value);
            const url = `/api/stats/export/${format}?period=${period}&count=${count}`;
            // Öffne Download-Link in neuem Tab
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Auth-Check beim Laden der Seite
        (async () => {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (data.authenticated) {
                    // Authentifiziert: Zeige Admin-Inhalt
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('loginRequired').style.display = 'none';
                    document.getElementById('logoutLink').style.display = 'block';
                    
                    // Logout-Handler
                    document.getElementById('logoutLink').addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            await fetch('/api/auth/logout', { method: 'POST' });
                            window.location.href = '/admin/login.html';
                        } catch (error) {
                            console.error('Logout-Fehler:', error);
                        }
                    });
                } else {
                    // Nicht authentifiziert: Zeige Login-Hinweis
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('loginRequired').style.display = 'block';
                    document.getElementById('logoutLink').style.display = 'none';
                }
            } catch (error) {
                console.error('Auth-Check Fehler:', error);
                // Bei Fehler: Zeige Login-Hinweis
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
            }
        })();
        
        // Beim Laden: Health-Checks ausführen
        document.addEventListener('DOMContentLoaded', () => {
            loadHealthChecks();
            loadLLMStatus();
            // Alle 30 Sekunden aktualisieren
            setInterval(loadHealthChecks, 30000);
            
            // Beim Tab-Wechsel Statistiken laden
            const statsTab = document.getElementById('stats-tab');
            if (statsTab) {
                statsTab.addEventListener('shown.bs.tab', () => {
                    loadStats();
                });
            }
            
            // Beim Tab-Wechsel Systemregeln laden
            const rulesTab = document.getElementById('rules-tab');
            if (rulesTab) {
                rulesTab.addEventListener('shown.bs.tab', () => {
                    loadSystemRules();
                });
            }
            
            // Formular-Handler registrieren
            const form = document.getElementById('system-rules-form');
            if (form) {
                form.addEventListener('submit', saveSystemRules);
            }
        });
        
        // Lade Systemregeln vom Backend
        async function loadSystemRules() {
            try {
                // Lade aktuelle Werte vom Backend
                const response = await fetch('/api/system/rules');
                const data = await response.json();
                
                // Aktualisiere alle Platzhalter
                const timeWithoutReturn = data.time_budget_without_return || 65;
                const timeWithReturn = data.time_budget_with_return || 90;
                const serviceTime = data.service_time_per_stop || 2;
                const speedKmh = data.speed_kmh || 50;
                const safetyFactor = data.safety_factor || 1.3;
                const depotCoords = data.depot_coords || '51.0111988, 13.7016485';
                
                // Aktualisiere alle Elemente
                document.querySelectorAll('#time-budget-without-return, #time-budget-without-return-2, #time-budget-without-return-3, #time-budget-without-return-4, #time-budget-without-return-5, #time-budget-without-return-6, #time-budget-without-return-7, #time-budget-without-return-8').forEach(el => {
                    if (el) el.textContent = timeWithoutReturn;
                });
                document.querySelectorAll('#time-budget-with-return, #time-budget-with-return-2').forEach(el => {
                    if (el) el.textContent = timeWithReturn;
                });
                const serviceTimeEl = document.getElementById('service-time-per-stop');
                if (serviceTimeEl) serviceTimeEl.textContent = serviceTime;
                const speedEl = document.getElementById('speed-kmh');
                if (speedEl) speedEl.textContent = speedKmh;
                document.querySelectorAll('#safety-factor, #safety-factor-2').forEach(el => {
                    if (el) el.textContent = safetyFactor;
                });
                const depotEl = document.getElementById('depot-coords');
                if (depotEl) depotEl.textContent = depotCoords;
                
                // Fülle Edit-Formular
                const editTimeWithoutReturn = document.getElementById('edit-time-budget-without-return');
                if (editTimeWithoutReturn) editTimeWithoutReturn.value = timeWithoutReturn;
                const editTimeWithReturn = document.getElementById('edit-time-budget-with-return');
                if (editTimeWithReturn) editTimeWithReturn.value = timeWithReturn;
                const editServiceTime = document.getElementById('edit-service-time-per-stop');
                if (editServiceTime) editServiceTime.value = serviceTime;
                const editSpeed = document.getElementById('edit-speed-kmh');
                if (editSpeed) editSpeed.value = speedKmh;
                const editSafetyFactor = document.getElementById('edit-safety-factor');
                if (editSafetyFactor) editSafetyFactor.value = safetyFactor;
                const editDepotLat = document.getElementById('edit-depot-lat');
                if (editDepotLat) editDepotLat.value = data.depot_lat || 51.0111988;
                const editDepotLon = document.getElementById('edit-depot-lon');
                if (editDepotLon) editDepotLon.value = data.depot_lon || 13.7016485;
            } catch (error) {
                console.error('Fehler beim Laden der Systemregeln:', error);
                // Verwende Standardwerte wenn API nicht verfügbar
            }
        }
        
        // Systemregeln speichern
        async function saveSystemRules(event) {
            event.preventDefault();
            const messageDiv = document.getElementById('rules-save-message');
            messageDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Speichere...</div>';
            
            try {
                const rules = {
                    time_budget_without_return: parseInt(document.getElementById('edit-time-budget-without-return').value),
                    time_budget_with_return: parseInt(document.getElementById('edit-time-budget-with-return').value),
                    service_time_per_stop: parseFloat(document.getElementById('edit-service-time-per-stop').value),
                    speed_kmh: parseFloat(document.getElementById('edit-speed-kmh').value),
                    safety_factor: parseFloat(document.getElementById('edit-safety-factor').value),
                    depot_lat: parseFloat(document.getElementById('edit-depot-lat').value),
                    depot_lon: parseFloat(document.getElementById('edit-depot-lon').value)
                };
                
                // Validiere Werte vor dem Senden
                if (isNaN(rules.time_budget_without_return) || rules.time_budget_without_return < 1 || rules.time_budget_without_return > 120) {
                    throw new Error('Zeitbudget ohne Rückfahrt muss zwischen 1 und 120 Minuten liegen');
                }
                if (isNaN(rules.time_budget_with_return) || rules.time_budget_with_return < 1 || rules.time_budget_with_return > 180) {
                    throw new Error('Zeitbudget mit Rückfahrt muss zwischen 1 und 180 Minuten liegen');
                }
                if (isNaN(rules.service_time_per_stop) || rules.service_time_per_stop < 0.5 || rules.service_time_per_stop > 10.0) {
                    throw new Error('Service-Zeit pro Stop muss zwischen 0.5 und 10.0 Minuten liegen');
                }
                if (isNaN(rules.speed_kmh) || rules.speed_kmh < 10 || rules.speed_kmh > 100) {
                    throw new Error('Geschwindigkeit muss zwischen 10 und 100 km/h liegen');
                }
                if (isNaN(rules.safety_factor) || rules.safety_factor < 1.0 || rules.safety_factor > 2.0) {
                    throw new Error('Sicherheitsfaktor muss zwischen 1.0 und 2.0 liegen');
                }
                if (isNaN(rules.depot_lat) || rules.depot_lat < -90 || rules.depot_lat > 90) {
                    throw new Error('Depot-Latitude muss zwischen -90 und 90 liegen');
                }
                if (isNaN(rules.depot_lon) || rules.depot_lon < -180 || rules.depot_lon > 180) {
                    throw new Error('Depot-Longitude muss zwischen -180 und 180 liegen');
                }
                
                const response = await fetch('/api/system/rules', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',  // Wichtig: Cookies mitsenden
                    body: JSON.stringify(rules)
                });
                
                if (!response.ok) {
                    let errorMessage = 'Fehler beim Speichern';
                    let errorDetails = [];
                    
                    try {
                        const errorData = await response.json();
                        
                        // Pydantic Validation Errors (422)
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                errorDetails = errorData.detail.map(e => ({
                                    field: e.loc.join('.'),
                                    message: e.msg
                                }));
                                errorMessage = errorDetails.map(e => `${e.field}: ${e.message}`).join(', ');
                            } else {
                                errorMessage = errorData.detail;
                            }
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                        
                        // Strukturierte Fehlermeldung für Frontend
                        if (response.status === 401) {
                            errorMessage = 'Authentifizierung erforderlich. Bitte melden Sie sich an.';
                        } else if (response.status === 422) {
                            errorMessage = 'Validierungsfehler: ' + errorMessage;
                        } else if (response.status === 500) {
                            errorMessage = 'Server-Fehler: ' + errorMessage;
                        }
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // Zeige detaillierte Fehlermeldung
                    if (errorDetails.length > 0) {
                        const detailsHtml = errorDetails.map(e => 
                            `<li><strong>${e.field}:</strong> ${e.message}</li>`
                        ).join('');
                        throw new Error(`<strong>Validierungsfehler:</strong><ul class="mb-0">${detailsHtml}</ul>`);
                    } else {
                        throw new Error(errorMessage);
                    }
                }
                
                const result = await response.json();
                messageDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Systemregeln erfolgreich gespeichert!</div>';
                
                // Aktualisiere Anzeige
                setTimeout(() => {
                    loadSystemRules();
                }, 500);
            } catch (error) {
                console.error('Fehler beim Speichern der Systemregeln:', error);
                
                // Prüfe ob Fehlermeldung HTML enthält (strukturierte Validierungsfehler)
                const isHtml = error.message && error.message.includes('<');
                const errorContent = isHtml ? error.message : (error.message || 'Unbekannter Fehler');
                
                messageDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Fehler:</strong> ${errorContent}</div>`;
            }
        }
        
        // Formular zurücksetzen (lädt aktuelle Werte)
        function resetSystemRulesForm() {
            loadSystemRules();
            const messageDiv = document.getElementById('rules-save-message');
            if (messageDiv) messageDiv.innerHTML = '';
        }
        
        // Auf Standard-Werte zurücksetzen
        function resetToDefaults() {
            if (!confirm('Möchten Sie wirklich alle Werte auf die Standard-Werte zurücksetzen?')) {
                return;
            }
            
            // Standard-Werte
            document.getElementById('edit-time-budget-without-return').value = 65;
            document.getElementById('edit-time-budget-with-return').value = 90;
            document.getElementById('edit-service-time-per-stop').value = 2.0;
            document.getElementById('edit-speed-kmh').value = 50;
            document.getElementById('edit-safety-factor').value = 1.3;
            document.getElementById('edit-depot-lat').value = 51.0111988;
            document.getElementById('edit-depot-lon').value = 13.7016485;
            
            const messageDiv = document.getElementById('rules-save-message');
            if (messageDiv) {
                messageDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Werte auf Standard zurückgesetzt. Bitte auf "Speichern" klicken, um zu übernehmen.</div>';
            }
        }
        // ===== DB-VERWALTUNG FUNKTIONEN =====
        
        // Validiere CSV-Dateien
        function validateCSVFiles() {
            const fileInput = document.getElementById('db-tourplan-upload');
            const files = fileInput.files;
            const messageDiv = document.getElementById('csv-validation-message');
            const uploadButton = document.getElementById('db-upload-button');
            
            // Reset
            messageDiv.style.display = 'none';
            messageDiv.className = 'mt-2';
            uploadButton.disabled = false;
            
            if (files.length === 0) {
                return;
            }
            
            // Prüfe Anzahl
            if (files.length > 10) {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-danger';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Maximal 10 Dateien erlaubt!';
                uploadButton.disabled = true;
                return;
            }
            
            // Prüfe Dateigröße und -typ
            const maxSize = 50 * 1024 * 1024; // 50 MB
            let errors = [];
            
            for (let file of files) {
                // Prüfe Dateityp
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    errors.push(`${file.name}: Nur CSV-Dateien erlaubt`);
                }
                
                // Prüfe Größe
                if (file.size > maxSize) {
                    errors.push(`${file.name}: Datei zu groß (max. 50 MB)`);
                }
                
                // Prüfe Leer-Datei
                if (file.size === 0) {
                    errors.push(`${file.name}: Datei ist leer`);
                }
            }
            
            if (errors.length > 0) {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-danger';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Validierung fehlgeschlagen:</strong><ul class="mb-0">' +
                    errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                uploadButton.disabled = true;
            } else {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-success';
                messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${files.length} Datei(en) bereit zum Hochladen`;
            }
        }
        
        // Tourenpläne hochladen und geocodieren
        async function uploadTourplansForGeocoding() {
            const fileInput = document.getElementById('db-tourplan-upload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Bitte wählen Sie mindestens eine CSV-Datei aus.');
                return;
            }
            
            // Nochmal validieren
            if (files.length > 10) {
                alert('Maximal 10 Dateien erlaubt!');
                return;
            }
            
            // Zeige Progress-Container
            document.getElementById('geocoding-progress-container').style.display = 'block';
            document.getElementById('geocoding-results').style.display = 'none';
            
            let totalSuccess = 0;
            let totalSkip = 0;
            let totalError = 0;
            let totalProcessed = 0;
            let totalCustomers = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateGeocodingStatus(`Verarbeite ${file.name} (${i + 1}/${files.length})...`, 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Upload und Geocoding
                    const response = await fetch('/api/tourplan/batch-geocode', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        totalError++;
                        updateGeocodingStatus(`Fehler bei ${file.name}: HTTP ${response.status}`, 'danger');
                        continue;
                    }
                    
                    const result = await response.json();
                    
                    // Aktualisiere Zähler
                    totalSuccess += result.geocoded_count || 0;
                    totalSkip += result.skipped_count || 0;
                    totalError += result.error_count || 0;
                    totalCustomers += result.total_customers || 0;
                    totalProcessed++;
                    
                    // Aktualisiere Progress
                    const progress = ((i + 1) / files.length) * 100;
                    updateGeocodingProgress(i + 1, files.length, progress);
                    
                } catch (error) {
                    totalError++;
                    updateGeocodingStatus(`Fehler bei ${file.name}: ${error.message}`, 'danger');
                }
            }
            
            // Zeige Ergebnisse
            document.getElementById('geocoding-results').style.display = 'block';
            document.getElementById('geocoding-success-count').textContent = totalSuccess;
            document.getElementById('geocoding-skip-count').textContent = totalSkip;
            document.getElementById('geocoding-error-count').textContent = totalError;
            document.getElementById('geocoding-total-count').textContent = totalCustomers;
            
            updateGeocodingStatus(`Abgeschlossen: ${totalProcessed} von ${files.length} Dateien verarbeitet`, 'success');
            
            // Lade DB-Statistiken neu
            loadDBStats();
            loadAvailableTourplans();
            
            // Reset File Input
            fileInput.value = '';
        }
        
        // Lade verfügbare Tourenpläne
        async function loadAvailableTourplans() {
            const listDiv = document.getElementById('tourplan-list');
            listDiv.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Lade...</div>';
            
            try {
                const response = await fetch('/api/tourplan/list');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const tourplans = data.tourplans || [];
                
                if (tourplans.length === 0) {
                    listDiv.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-info-circle"></i> Keine Tourenpläne gefunden</div>';
                    return;
                }
                
                listDiv.innerHTML = tourplans.map(tp => `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${tp.filename}</h6>
                            <small class="text-muted">
                                ${tp.customer_count} Kunden | ${tp.geocoded_count} geocodiert (${tp.geocode_rate}%)
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="geocodeSingleTourplan('${tp.filename}')">
                            <i class="fas fa-map-marker-alt"></i> Geocodieren
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                listDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Fehler: ${error.message}</div>`;
            }
        }
        
        // Geocodiere einen einzelnen Tourplan
        async function geocodeSingleTourplan(filename) {
            updateGeocodingStatus(`Geocodiere ${filename}...`, 'info');
            document.getElementById('geocoding-progress-container').style.display = 'block';
            
            try {
                const response = await fetch('/api/tourplan/geocode-file', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // Zeige Ergebnisse
                document.getElementById('geocoding-results').style.display = 'block';
                document.getElementById('geocoding-success-count').textContent = result.geocoded_count || 0;
                document.getElementById('geocoding-skip-count').textContent = result.skipped_count || 0;
                document.getElementById('geocoding-error-count').textContent = result.error_count || 0;
                document.getElementById('geocoding-total-count').textContent = result.total_customers || 0;
                
                updateGeocodingStatus(`Abgeschlossen: ${filename}`, 'success');
                
                // Lade Listen neu
                loadDBStats();
                loadAvailableTourplans();
                
            } catch (error) {
                updateGeocodingStatus(`Fehler: ${error.message}`, 'danger');
            }
        }
        
        // Geocodiere alle Tourenpläne
        async function geocodeAllTourplans() {
            if (!confirm('Wirklich ALLE Tourenpläne geocodieren? Dies kann lange dauern.')) {
                return;
            }
            
            updateGeocodingStatus('Lade Tourenpläne...', 'info');
            document.getElementById('geocoding-progress-container').style.display = 'block';
            
            try {
                const response = await fetch('/api/tourplan/list');
                const data = await response.json();
                const tourplans = data.tourplans || [];
                
                let totalSuccess = 0;
                let totalSkip = 0;
                let totalError = 0;
                let totalCustomers = 0;
                
                for (let i = 0; i < tourplans.length; i++) {
                    const tp = tourplans[i];
                    updateGeocodingStatus(`Verarbeite ${tp.filename} (${i + 1}/${tourplans.length})...`, 'info');
                    
                    try {
                        const response = await fetch('/api/tourplan/geocode-file', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({filename: tp.filename})
                        });
                        
                        const result = await response.json();
                        totalSuccess += result.geocoded_count || 0;
                        totalSkip += result.skipped_count || 0;
                        totalError += result.error_count || 0;
                        totalCustomers += result.total_customers || 0;
                        
                        // Aktualisiere Progress
                        const progress = ((i + 1) / tourplans.length) * 100;
                        updateGeocodingProgress(i + 1, tourplans.length, progress);
                        
                    } catch (error) {
                        totalError++;
                    }
                }
                
                // Zeige Ergebnisse
                document.getElementById('geocoding-results').style.display = 'block';
                document.getElementById('geocoding-success-count').textContent = totalSuccess;
                document.getElementById('geocoding-skip-count').textContent = totalSkip;
                document.getElementById('geocoding-error-count').textContent = totalError;
                document.getElementById('geocoding-total-count').textContent = totalCustomers;
                
                updateGeocodingStatus(`Abgeschlossen: ${tourplans.length} Tourenpläne verarbeitet`, 'success');
                
                // Lade Listen neu
                loadDBStats();
                loadAvailableTourplans();
                
            } catch (error) {
                updateGeocodingStatus(`Fehler: ${error.message}`, 'danger');
            }
        }
        
        // Update Geocoding Progress
        function updateGeocodingProgress(current, total, percent) {
            document.getElementById('geocoding-progress-text').textContent = `${current} / ${total}`;
            document.getElementById('geocoding-progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('geocoding-progress-bar').style.width = `${percent}%`;
        }
        
        // Update Geocoding Status
        function updateGeocodingStatus(message, type) {
            const statusDiv = document.getElementById('geocoding-status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = `<small>${message}</small>`;
        }
        
        // Lade DB-Statistiken
        async function loadDBStats() {
            try {
                const response = await fetch('/api/db/stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('db-customers-count').textContent = data.total_customers || 0;
                document.getElementById('db-geocoded-count').textContent = data.geocoded_customers || 0;
                document.getElementById('db-missing-count').textContent = data.missing_geocodes || 0;
                document.getElementById('db-geocode-percent').textContent = `${data.geocode_rate || 0}%`;
                
            } catch (error) {
                console.error('Fehler beim Laden der DB-Statistiken:', error);
            }
        }
    </script>
    </div> <!-- Ende adminContent -->
</body>
</html>

