<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMO TrafficApp - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .health-card { margin-bottom: 1rem; }
        .health-ok { border-left: 4px solid #28a745; }
        .health-error { border-left: 4px solid #dc3545; }
        .health-warning { border-left: 4px solid #ffc107; }
        .latency { font-size: 0.9em; color: #6c757d; }
        .stat-kpi-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        .stat-kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-kpi-card h4 {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .admin-nav-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .admin-nav-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            padding: 0;
            margin: 0;
        }
        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            background-color: transparent;
            position: relative;
        }
        .admin-nav-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            border-bottom-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        .admin-nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border-bottom: 3px solid #ffffff;
            font-weight: 600;
        }
        .admin-nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ffffff;
            border-radius: 0 4px 4px 0;
        }
        .admin-nav-item i {
            font-size: 1.1em;
        }
        .kpi-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .kpi-card h4 {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .tour-table {
            font-size: 0.9rem;
        }
        .tour-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">FAMO TrafficApp</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Hauptseite</a>
                <a class="nav-link active" href="/admin.html">Admin</a>
                <a class="nav-link" href="#" id="logoutLink" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Login-Check (wird ausgeblendet wenn authentifiziert) -->
    <div id="loginRequired" style="display: none;">
        <div class="container mt-5">
            <div class="alert alert-warning">
                <h4><i class="fas fa-lock"></i> Authentifizierung erforderlich</h4>
                <p>Sie müssen sich einloggen, um auf den Admin-Bereich zuzugreifen.</p>
                <a href="/admin/login.html" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Zum Login
                </a>
            </div>
        </div>
    </div>
    
    <!-- Admin-Inhalt (wird ausgeblendet wenn nicht authentifiziert) -->
    <div id="adminContent">

    <div class="container-fluid mt-4">
        <h1><i class="fas fa-cog"></i> Admin-Bereich</h1>
        
        <!-- Admin-Navigation -->
        <nav class="admin-nav-bar">
            <div class="admin-nav-items">
                <a href="/admin/system.html" class="admin-nav-item active">
                    <i class="fas fa-heartbeat"></i>
                    <span>System/Health</span>
                </a>
                <a href="/admin/statistik.html" class="admin-nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistik</span>
                </a>
                <a href="/admin/systemregeln.html" class="admin-nav-item">
                    <i class="fas fa-book"></i>
                    <span>Systemregeln</span>
                </a>
                <a href="/admin/ki-integration.html" class="admin-nav-item">
                    <i class="fas fa-robot"></i>
                    <span>KI-Integration</span>
                </a>
                <a href="/admin/db-verwaltung.html" class="admin-nav-item">
                    <i class="fas fa-database"></i>
                    <span>DB-Verwaltung</span>
                </a>
                <a href="/admin/tour-filter.html" class="admin-nav-item">
                    <i class="fas fa-filter"></i>
                    <span>Tour-Filter</span>
                </a>
                <a href="/admin/tour-import.html" class="admin-nav-item">
                    <i class="fas fa-upload"></i>
                    <span>Tour-Import</span>
                </a>
                <a href="/admin/geo-cache-vorverarbeitung.html" class="admin-nav-item">
                    <i class="fas fa-fill-drip"></i>
                    <span>Geo-Cache Vorverarbeitung</span>
                </a>
                <a href="#" class="admin-nav-item" onclick="showTourplanTab(event); return false;">
                    <i class="fas fa-list-alt"></i>
                    <span>Tourplan-Übersicht</span>
                </a>
                <a href="/admin/tankpreise.html" class="admin-nav-item">
                    <i class="fas fa-gas-pump"></i>
                    <span>Tank- & Strompreise</span>
                </a>
                <a href="/admin/dataflow.html" class="admin-nav-item">
                    <i class="fas fa-project-diagram"></i>
                    <span>Datenfluss</span>
                </a>
                <a href="#" class="admin-nav-item" onclick="showUsersTab(event); return false;">
                    <i class="fas fa-users-cog"></i>
                    <span>Benutzerverwaltung</span>
                </a>
                <a href="#" class="admin-nav-item" onclick="showGeocodeFailuresTab(event); return false;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Geocoding-Fehler</span>
                </a>
            </div>
        </nav>
        
        <!-- Übersichtsseite -->
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle"></i> 
            <strong>Hinweis:</strong> Diese Seite ist eine Übersichtsseite. Für detaillierte Funktionen nutzen Sie bitte die Navigation oben.
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <a href="/admin/system.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-success mb-2">
                            <i class="fas fa-heartbeat fa-3x"></i>
                        </div>
                        <h5 class="card-title">System/Health</h5>
                        <p class="card-text text-muted">System-Status und Health-Checks</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/statistik.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-primary mb-2">
                            <i class="fas fa-chart-bar fa-3x"></i>
                        </div>
                        <h5 class="card-title">Statistik</h5>
                        <p class="card-text text-muted">KPIs, Charts und Export</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/systemregeln.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-info mb-2">
                            <i class="fas fa-book fa-3x"></i>
                        </div>
                        <h5 class="card-title">Systemregeln</h5>
                        <p class="card-text text-muted">System-Konfigurationsregeln</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/ki-integration.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-warning mb-2">
                            <i class="fas fa-robot fa-3x"></i>
                        </div>
                        <h5 class="card-title">KI-Integration</h5>
                        <p class="card-text text-muted">Kostenkontrolle & Verhalten</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/db-verwaltung.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-secondary mb-2">
                            <i class="fas fa-database fa-3x"></i>
                        </div>
                        <h5 class="card-title">DB-Verwaltung</h5>
                        <p class="card-text text-muted">Datenbank-Informationen</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/tour-filter.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-danger mb-2">
                            <i class="fas fa-filter fa-3x"></i>
                        </div>
                        <h5 class="card-title">Tour-Filter</h5>
                        <p class="card-text text-muted">Ignore/Allow-Listen</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/tour-import.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-success mb-2">
                            <i class="fas fa-upload fa-3x"></i>
                        </div>
                        <h5 class="card-title">Tour-Import</h5>
                        <p class="card-text text-muted">Upload & Geocoding</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="/admin/dataflow.html" class="card text-decoration-none text-dark h-100">
                    <div class="card-body text-center">
                        <div class="text-primary mb-2">
                            <i class="fas fa-project-diagram fa-3x"></i>
                        </div>
                        <h5 class="card-title">Datenfluss</h5>
                        <p class="card-text text-muted">System-Architektur</p>
                    </div>
                </a>
            </div>
        </div>
        
        <!-- Übersichtsseite mit Karten -->
        <!-- Alle Tab-Panes wurden entfernt, da die Funktionen jetzt auf separaten Seiten sind -->
                                <h5 class="mb-0"><i class="fas fa-route"></i> OSRM Health</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-osrm-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-db-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-database"></i> Database Health</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-db-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-osrm-sample-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-map"></i> OSRM Sample Route</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-osrm-sample-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-workflow-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cogs"></i> Workflow Engine</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-workflow-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-llm-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-robot"></i> LLM Integration</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-llm-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-system-rules-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-book"></i> Systemregeln</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-system-rules-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card health-card" id="health-combined-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-check-circle"></i> Gesamt-Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="health-combined-content">Lade...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Systemregeln Tab -->
            <div class="tab-pane fade" id="rules" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h3><i class="fas fa-book"></i> Systemregeln für Routen-Aufsplittung</h3>
                        <p class="text-muted">Diese Regeln werden vom LLM und der Optimierungs-Engine verwendet.</p>
                        
                        <!-- Editier-Formular für Systemregeln (oben) -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-edit"></i> Systemregeln bearbeiten</h5>
                            </div>
                            <div class="card-body">
                                <form id="system-rules-form">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-time-budget-without-return" class="form-label">
                                                Zeitbudget ohne Rückfahrt (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-time-budget-without-return" 
                                                   min="1" max="120" step="1" required>
                                            <small class="form-text text-muted">Hauptregel: Tour muss ≤ diesem Wert sein (ohne Rückfahrt)</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-time-budget-with-return" class="form-label">
                                                Zeitbudget mit Rückfahrt (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-time-budget-with-return" 
                                                   min="1" max="180" step="1" required>
                                            <small class="form-text text-muted">Gesamtzeit inkl. Rückfahrt</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-service-time-per-stop" class="form-label">
                                                Service-Zeit pro Stop (Minuten)
                                            </label>
                                            <input type="number" class="form-control" id="edit-service-time-per-stop" 
                                                   min="0.5" max="10" step="0.1" required>
                                            <small class="form-text text-muted">Standard-Service-Zeit pro Kunde</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-speed-kmh" class="form-label">
                                                Durchschnittsgeschwindigkeit (km/h)
                                            </label>
                                            <input type="number" class="form-control" id="edit-speed-kmh" 
                                                   min="10" max="100" step="1" required>
                                            <small class="form-text text-muted">Für Stadtverkehr</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="edit-safety-factor" class="form-label">
                                                Sicherheitsfaktor (Stadtverkehr)
                                            </label>
                                            <input type="number" class="form-control" id="edit-safety-factor" 
                                                   min="1.0" max="2.0" step="0.1" required>
                                            <small class="form-text text-muted">
                                                <strong>Was ist das?</strong><br>
                                                Der Sicherheitsfaktor kompensiert die Differenz zwischen Luftlinie (Haversine) und tatsächlicher Straßenentfernung im Stadtverkehr.<br>
                                                <strong>Standard: 1.3</strong> bedeutet: Luftlinie × 1.3 = geschätzte Straßenentfernung<br>
                                                <strong>Beispiel:</strong> 10 km Luftlinie → 13 km Straßenentfernung (bei Faktor 1.3)<br>
                                                <strong>Warum?</strong> In Städten sind Straßen länger als die direkte Luftlinie (Einbahnstraßen, Umwege, Verkehrsführung).<br>
                                                <strong>Anpassung:</strong> Höhere Werte (z.B. 1.5) für komplexe Stadtgebiete, niedrigere (z.B. 1.1) für einfache Routen.
                                            </small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="edit-depot-lat" class="form-label">
                                                Depot Latitude
                                            </label>
                                            <input type="number" class="form-control" id="edit-depot-lat" 
                                                   min="-90" max="90" step="0.0000001" required>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="edit-depot-lon" class="form-label">
                                                Depot Longitude
                                            </label>
                                            <input type="number" class="form-control" id="edit-depot-lon" 
                                                   min="-180" max="180" step="0.0000001" required>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Speichern
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="resetSystemRulesForm()">
                                            <i class="fas fa-undo"></i> Zurücksetzen
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                                            <i class="fas fa-redo"></i> Standard-Werte
                                        </button>
                                    </div>
                                    <div id="rules-save-message" class="mt-3"></div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 1. Zeit-Constraints (HÖCHSTE PRIORITÄT)</h5>
                            </div>
                            <div class="card-body">
                                <h6>Hauptregel: Tour-Zeit OHNE Rückfahrt</h6>
                                <ul>
                                    <li><strong>KRITISCH:</strong> Jede Tour muss <strong>≤ <span id="time-budget-without-return">65</span> Minuten (OHNE Rückfahrt)</strong> sein!</li>
                                    <li>Berechnung: <code>Fahrzeit + Servicezeit ≤ <span id="time-budget-without-return-2">65</span> Minuten</code></li>
                                    <li>Rückfahrt zum Depot kommt <strong>DANACH</strong> und zählt <strong>NICHT</strong> in die <span id="time-budget-without-return-3">65</span> Minuten!</li>
                                    <li>Wenn eine Gruppe zu groß wäre → <strong>ERSTELLE MEHRERE SEPARATE TOUREN (A, B, C, D, E)</strong>, NICHT Unterrouten!</li>
                                </ul>
                                
                                <h6 class="mt-3">Zeitbox-Regel: Gesamtzeit INKL. Rückfahrt</h6>
                                <ul>
                                    <li>Gesamtzeit inkl. Rückfahrt darf <strong>≤ <span id="time-budget-with-return">90</span> Minuten</strong> betragen</li>
                                    <li>Dies ist eine zusätzliche Prüfung nach der Hauptregel</li>
                                </ul>
                                
                                <h6 class="mt-3">Service-Zeit pro Kunde</h6>
                                <ul>
                                    <li><strong>Standard:</strong> <span id="service-time-per-stop">2</span> Minuten pro Kunde</li>
                                    <li>Kann pro Kunde individuell angepasst werden</li>
                                    <li>Wird zur Fahrzeit addiert</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> 2. Geografische Optimierung</h5>
                            </div>
                            <div class="card-body">
                                <h6>Priorität (Reihenfolge ist wichtig!)</h6>
                                <ol>
                                    <li><strong>Zeit-Constraint ≤ <span id="time-budget-without-return-4">65</span> Min (ohne Rückfahrt)</strong> - MUSS erfüllt sein</li>
                                    <li><strong>Geografische Nähe</strong> - Gruppiere Kunden nach Entfernung zueinander</li>
                                    <li><strong>Max. Stopps pro Tour</strong> - Nur wenn Zeit-Constraint erfüllt ist!</li>
                                </ol>
                                
                                <h6 class="mt-3">Max. Stopps pro Tour</h6>
                                <ul>
                                    <li><strong>KEIN Limit</strong> - so viele Stopps wie möglich, solange Zeit-Constraint (≤ <span id="time-budget-without-return-5">65</span> Min ohne Rückfahrt) erfüllt ist!</li>
                                    <li>Wenn Zeit-Constraint nicht erfüllt → weniger Stopps pro Tour, mehr Touren erstellen!</li>
                                </ul>
                                
                                <h6 class="mt-3">Straßenbasierte Clustering</h6>
                                <ul>
                                    <li><strong>Priorität:</strong> Kunden auf derselben Straße zusammenhalten</li>
                                    <li>Beispiel: Alle "Fröbelstraße"-Stopps sollten zusammen bleiben, bevor zu "Tharandter Straße" gewechselt wird</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-warehouse"></i> 3. Depot als Start- und Endpunkt</h5>
                            </div>
                            <div class="card-body">
                                <h6>Depot-Koordinaten</h6>
                                <ul>
                                    <li><strong>FAMO Dresden:</strong> <code id="depot-coords">51.0111988, 13.7016485</code></li>
                                    <li>Alle Touren starten und enden am Depot</li>
                                    <li>Depot wird <strong>nicht</strong> als Stop in der Tour-Liste angezeigt</li>
                                </ul>
                                
                                <h6 class="mt-3">Rückfahrt-Berechnung</h6>
                                <ul>
                                    <li>Rückfahrt vom letzten Kunden zum Depot wird <strong>separat</strong> berechnet</li>
                                    <li>Zählt <strong>NICHT</strong> in die <span id="time-budget-without-return-6">65</span>-Minuten-Regel</li>
                                    <li>Wird zur finalen Gesamtzeit addiert</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-sitemap"></i> 4. Tour-Aufteilung</h5>
                            </div>
                            <div class="card-body">
                                <h6>Wenn Tour zu groß ist</h6>
                                <ul>
                                    <li><strong>NICHT:</strong> Sub-Routen (C1, C2) erstellen</li>
                                    <li><strong>SONDERN:</strong> Separate Touren (A, B, C, D, E) erstellen</li>
                                    <li>Jede separate Tour muss die <span id="time-budget-without-return-7">65</span>-Minuten-Regel erfüllen</li>
                                </ul>
                                
                                <h6 class="mt-3">Tour-Namen für separate Touren</h6>
                                <ul>
                                    <li>Format: <code>{Original-Name} Tour {Buchstabe}</code></li>
                                    <li>Beispiel: <code>W-07.00 Uhr Tour A</code>, <code>W-07.00 Uhr Tour B</code>, etc.</li>
                                    <li>Buchstaben: A, B, C, D, E, ...</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-route"></i> 5. OSRM-First Strategie</h5>
                            </div>
                            <div class="card-body">
                                <h6>Distanz- und Zeitberechnung</h6>
                                <ol>
                                    <li><strong>Priorität 1:</strong> OSRM (Open Source Routing Machine) - straßenbasierte Routen</li>
                                    <li><strong>Priorität 2:</strong> Haversine-Distanz × <span id="safety-factor">1.3</span> (Fallback für Stadtverkehr)</li>
                                    <li><strong>NICHT:</strong> Luftlinie ohne Anpassung verwenden!</li>
                                </ol>
                                
                                <h6 class="mt-3">Durchschnittsgeschwindigkeit</h6>
                                <ul>
                                    <li><strong>Stadtverkehr:</strong> <span id="speed-kmh">50</span> km/h</li>
                                </ul>
                                
                                <h6 class="mt-3">Sicherheitsfaktor für Stadtverkehr</h6>
                                <ul>
                                    <li><strong>Standard:</strong> <span id="safety-factor-2">1.3</span> (30% Aufschlag auf Luftlinie)</li>
                                    <li><strong>Berechnung:</strong> <code>Straßenentfernung = Haversine-Distanz × Sicherheitsfaktor</code></li>
                                    <li><strong>Beispiel:</strong> 10 km Luftlinie → 13 km Straßenentfernung (bei Faktor 1.3)</li>
                                    <li><strong>Zweck:</strong> Kompensiert die Differenz zwischen Luftlinie (Haversine) und tatsächlicher Straßenentfernung im Stadtverkehr</li>
                                    <li><strong>Warum nötig?</strong> In Städten sind Straßen länger als die direkte Luftlinie durch:
                                        <ul>
                                            <li>Einbahnstraßen und Verkehrsführung</li>
                                            <li>Umwege und nicht-direkte Straßenverbindungen</li>
                                            <li>Verkehrsregelungen und Ampeln</li>
                                        </ul>
                                    </li>
                                    <li><strong>Anpassung:</strong>
                                        <ul>
                                            <li><strong>1.1-1.2:</strong> Einfache Routen, direkte Verbindungen</li>
                                            <li><strong>1.3:</strong> Standard für Stadtverkehr (empfohlen)</li>
                                            <li><strong>1.4-1.5:</strong> Komplexe Stadtgebiete, viele Umwege</li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0"><i class="fas fa-route"></i> 5.1. Routenoptimierung (Nearest-Neighbor + 2-Opt)</h5>
                            </div>
                            <div class="card-body">
                                <h6>Optimierungsverfahren</h6>
                                <p>Die Routenoptimierung erfolgt in zwei Schritten:</p>
                                <ol>
                                    <li><strong>Nearest-Neighbor (Nächster-Nachbar):</strong> Erstellt eine initiale Route</li>
                                    <li><strong>2-Opt-Verbesserung:</strong> Optimiert die Route durch Entfernung von Kreuzungen</li>
                                </ol>
                                
                                <h6 class="mt-3">1. Nearest-Neighbor-Verfahren</h6>
                                <ul>
                                    <li><strong>Funktionsweise:</strong>
                                        <ul>
                                            <li>Startet beim ersten Stopp (oder Depot)</li>
                                            <li>Wählt immer den <strong>nächsten noch nicht besuchten Stopp</strong> (Luftlinie)</li>
                                            <li>Wiederholt bis alle Stopps besucht sind</li>
                                        </ul>
                                    </li>
                                    <li><strong>Vorteile:</strong>
                                        <ul>
                                            <li>Sehr schnell (O(n²) Komplexität)</li>
                                            <li>Deterministisch (immer gleiche Route bei gleichen Eingaben)</li>
                                            <li>Keine externe Abhängigkeiten</li>
                                        </ul>
                                    </li>
                                    <li><strong>Nachteile:</strong>
                                        <ul>
                                            <li>Kann zu suboptimalen Routen führen (z.B. weit weg fahren, dann zurück)</li>
                                            <li>Berücksichtigt nicht die Gesamtroute</li>
                                            <li>Kann Kreuzungen in der Route erzeugen</li>
                                        </ul>
                                    </li>
                                    <li><strong>Warum verwenden wir es?</strong>
                                        <ul>
                                            <li>Als <strong>Fallback</strong>, wenn LLM-Optimierung nicht verfügbar ist</li>
                                            <li>Als <strong>Startpunkt</strong> für die 2-Opt-Verbesserung</li>
                                            <li>Garantiert immer eine gültige Route (auch bei vielen Stopps)</li>
                                        </ul>
                                    </li>
                                </ul>
                                
                                <h6 class="mt-3">2. 2-Opt-Verbesserung</h6>
                                <ul>
                                    <li><strong>Funktionsweise:</strong>
                                        <ul>
                                            <li>Testet alle möglichen Segment-Umkehrungen in der Route</li>
                                            <li>Wenn eine Umkehrung die Gesamtdistanz verkürzt → übernimmt sie</li>
                                            <li>Wiederholt bis keine Verbesserung mehr möglich (max. 10 Iterationen)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Beispiel:</strong>
                                        <ul>
                                            <li><strong>Vorher:</strong> A → B → C → D → E (mit Kreuzung zwischen B-C und D-E)</li>
                                            <li><strong>2-Opt Swap:</strong> Umkehrung von C-D → A → B → D → C → E</li>
                                            <li><strong>Ergebnis:</strong> Kürzere Route ohne Kreuzung</li>
                                        </ul>
                                    </li>
                                    <li><strong>Vorteile:</strong>
                                        <ul>
                                            <li>Entfernt Kreuzungen aus der Route</li>
                                            <li>Reduziert die Gesamtdistanz deutlich (oft 10-30% Verbesserung)</li>
                                            <li>Verhindert unnötige Umwege durch die Stadt</li>
                                        </ul>
                                    </li>
                                    <li><strong>Warum kombinieren wir beide?</strong>
                                        <ul>
                                            <li><strong>Nearest-Neighbor:</strong> Schnelle initiale Route</li>
                                            <li><strong>2-Opt:</strong> Verbessert die Route und entfernt Kreuzungen</li>
                                            <li><strong>Ergebnis:</strong> Gute Balance zwischen Geschwindigkeit und Qualität</li>
                                        </ul>
                                    </li>
                                </ul>
                                
                                <h6 class="mt-3">Priorität der Optimierungsmethoden</h6>
                                <ol>
                                    <li><strong>LLM-Optimierung</strong> (wenn aktiviert und Confidence > 0.7)</li>
                                    <li><strong>Nearest-Neighbor + 2-Opt</strong> (Fallback, wenn LLM nicht verfügbar)</li>
                                    <li><strong>Original-Reihenfolge</strong> (nur bei kritischen Fehlern)</li>
                                </ol>
                                
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle"></i> <strong>Hinweis:</strong> Die 2-Opt-Verbesserung wurde am 2025-11-19 hinzugefügt, um das Problem von unnötigen Umwegen durch die Stadt zu beheben.
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0"><i class="fas fa-compass"></i> 6. Sektor-Planung (W-Touren)</h5>
                            </div>
                            <div class="card-body">
                                <h6>Automatische Sektor-Planung</h6>
                                <ul>
                                    <li><strong>Nur für W-Touren</strong> (Tour-Name beginnt mit "W-")</li>
                                    <li>Dresden wird in 4 Sektoren aufgeteilt: <strong>Nord (N), Ost (O), Süd (S), West (W)</strong></li>
                                    <li>Stopps werden nach Himmelsrichtung (Bearing) vom Depot zugeordnet</li>
                                    <li><strong>Feste Cluster:</strong> Stopps bleiben in ihrem Sektor (keine Verschiebung zwischen Sektoren)</li>
                                </ul>
                                
                                <h6 class="mt-3">Zeitbox für W-Touren</h6>
                                <ul>
                                    <li>Start: <strong>07:00 Uhr</strong></li>
                                    <li>Hard Deadline: <strong>09:00 Uhr</strong></li>
                                    <li>Time Budget: <strong><span id="time-budget-with-return-2">90</span> Minuten</strong> (inkl. Rückfahrt)</li>
                                    <li>Aber: Hauptregel (≤ <span id="time-budget-without-return-8">65</span> Min ohne Rückfahrt) hat weiterhin Priorität!</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle"></i> Hinweis</h6>
                            <p>Diese Regeln werden automatisch vom System angewendet. Änderungen werden in <code>config/system_rules.json</code> gespeichert.</p>
                            <p><small>Quelle: <code>config/system_rules.json</code> (wird automatisch erstellt)</small></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KI-Integration Tab (vereinfacht) -->
            <div class="tab-pane fade" id="ki-integration" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-robot"></i> KI-Integration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Detaillierte KI-Analysen und Verwaltung finden Sie auf den spezialisierten Seiten:</p>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="/admin/ki-improvements" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" style="min-height: 120px;">
                                    <i class="fas fa-code fa-2x mb-2"></i>
                                    <strong>KI-CodeChecker</strong>
                                    <small class="text-muted mt-1">Code-Verbesserungen</small>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/admin/ki-kosten" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" style="min-height: 120px;">
                                    <i class="fas fa-coins fa-2x mb-2"></i>
                                    <strong>KI-Kosten</strong>
                                    <small class="text-muted mt-1">Kosten & Modelle</small>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/admin/ki-verhalten" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" style="min-height: 120px;">
                                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                    <strong>KI-Verhalten</strong>
                                    <small class="text-muted mt-1">Performance & Effektivität</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ende KI-Integration Tab -->

            <!-- Statistik Tab -->
            <div class="tab-pane fade" id="stats" role="tabpanel">
                <!-- KPI-Boxen -->
                <div class="row mb-4" id="stats-kpi-boxes">
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-primary stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-primary mb-1" id="kpi-tours">-</h4>
                                <small class="text-muted">Touren gesamt</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-success stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-success mb-1" id="kpi-km">-</h4>
                                <small class="text-muted">Kilometer</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-info stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-info mb-1" id="kpi-avg-stops">-</h4>
                                <small class="text-muted">Ø Stops/Tour</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-warning stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-warning mb-1" id="kpi-avg-delay">-</h4>
                                <small class="text-muted">Ø Verspätung</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-secondary stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-secondary mb-1" id="kpi-avg-score">-</h4>
                                <small class="text-muted">Ø Success-Score</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center border-danger stat-kpi-card">
                            <div class="card-body">
                                <h4 class="text-danger mb-1" id="kpi-abort-rate">-</h4>
                                <small class="text-muted">Abbruchquote</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Statistik-Details</h5>
                        <div>
                            <select id="stats-period" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                <option value="daily">Täglich</option>
                                <option value="monthly" selected>Monatlich</option>
                            </select>
                            <select id="stats-count" class="form-select form-select-sm d-inline-block ms-2" style="width: auto;">
                                <option value="7">7</option>
                                <option value="14">14</option>
                                <option value="30" selected>30</option>
                                <option value="90">90</option>
                                <option value="365">365</option>
                            </select>
                            <button class="btn btn-sm btn-primary ms-2" onclick="loadStats()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="stats-loading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin"></i> Lade Statistiken...
                        </div>
                        <div id="stats-content" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Touren</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-tours"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Stops</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-stops"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Kilometer geplant vs. real</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-km"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header"><h6 class="mb-0">Verspätung & Score</h6></div>
                                        <div class="card-body">
                                            <canvas id="chart-delay-score"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="exportStats('csv')">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button class="btn btn-info" onclick="exportStats('json')">
                                    <i class="fas fa-file-code"></i> Export JSON
                                </button>
                            </div>
                        </div>
                        <div id="stats-error" class="alert alert-danger" style="display: none;"></div>
                    </div>
                </div>
            
            <!-- Benutzerverwaltung Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab" style="display: none;">
                <h3 class="mb-4"><i class="fas fa-users-cog"></i> Benutzerverwaltung</h3>
                
                <!-- Benutzer-Liste -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users"></i> Benutzer</h5>
                        <button class="btn btn-light btn-sm" onclick="showCreateUserForm()">
                            <i class="fas fa-plus"></i> Neuer Benutzer
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="users-alert-container"></div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Benutzername</th>
                                        <th>Rolle</th>
                                        <th>E-Mail</th>
                                        <th>Vollständiger Name</th>
                                        <th>Aktiv</th>
                                        <th>Letzter Login</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Lade Benutzer...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Benutzer erstellen/bearbeiten Modal -->
                <div class="modal fade" id="userModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="userModalTitle">
                                    <i class="fas fa-user-plus"></i> Neuer Benutzer
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="userForm">
                                    <input type="hidden" id="user-id" name="user_id">
                                    
                                    <div class="mb-3">
                                        <label for="user-username" class="form-label">Benutzername *</label>
                                        <input type="text" class="form-control" id="user-username" name="username" required>
                                    </div>
                                    
                                    <div class="mb-3" id="password-fields">
                                        <label for="user-password" class="form-label">Passwort *</label>
                                        <input type="password" class="form-control" id="user-password" name="password" required>
                                        <small class="form-text text-muted">Mindestens 8 Zeichen</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="user-role" class="form-label">Rolle *</label>
                                        <select class="form-select" id="user-role" name="role" required>
                                            <option value="normal">Normal</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="user-email" class="form-label">E-Mail</label>
                                        <input type="email" class="form-control" id="user-email" name="email">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="user-fullname" class="form-label">Vollständiger Name</label>
                                        <input type="text" class="form-control" id="user-fullname" name="full_name">
                                    </div>
                                    
                                    <div class="mb-3" id="user-active-field" style="display: none;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="user-active" name="active" checked>
                                            <label class="form-check-label" for="user-active">
                                                Aktiv
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                <button type="button" class="btn btn-primary" onclick="saveUser()">
                                    <i class="fas fa-save"></i> Speichern
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Passwort ändern Modal -->
                <div class="modal fade" id="passwordModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-key"></i> Passwort ändern
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="passwordForm">
                                    <input type="hidden" id="password-user-id" name="user_id">
                                    
                                    <div class="mb-3">
                                        <label for="new-password" class="form-label">Neues Passwort *</label>
                                        <input type="password" class="form-control" id="new-password" name="new_password" required>
                                        <small class="form-text text-muted">Mindestens 8 Zeichen</small>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                <button type="button" class="btn btn-primary" onclick="savePassword()">
                                    <i class="fas fa-save"></i> Passwort ändern
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DB-Verwaltung Tab -->
            <!-- Tourplan-Übersicht Tab (AR-09: Konsolidiert aus tourplan-uebersicht.html) -->
            <div class="tab-pane fade" id="tourplan" role="tabpanel" aria-labelledby="tourplan-tab" style="display: none;">
                <h3 class="mb-4"><i class="fas fa-list-alt"></i> Tourplan-Übersicht</h3>
                
                <!-- Tourplan-Auswahl -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Tourplan auswählen</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="tourplan-select" class="form-label">Tourplan auswählen:</label>
                                <select id="tourplan-select" class="form-select" onchange="loadTourplanOverview()">
                                    <option value="">-- Bitte Tourplan auswählen --</option>
                                </select>
                                <small class="text-muted" id="tourplan-filename"></small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end gap-2">
                                <button class="btn btn-primary" onclick="loadTourplanList()">
                                    <i class="fas fa-sync"></i> Liste aktualisieren
                                </button>
                                <button class="btn btn-success" onclick="document.getElementById('file-upload').click()">
                                    <i class="fas fa-upload"></i> Tourplan hochladen
                                </button>
                                <input type="file" id="file-upload" accept=".csv" style="display: none;" onchange="uploadTourplan(event)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gesamt-KPIs -->
                <div id="kpi-section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-primary kpi-card">
                                <div class="card-body">
                                    <h4 class="text-primary mb-1" id="kpi-tours">-</h4>
                                    <small class="text-muted">Touren</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-success kpi-card">
                                <div class="card-body">
                                    <h4 class="text-success mb-1" id="kpi-stops">-</h4>
                                    <small class="text-muted">Stops</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-info kpi-card">
                                <div class="card-body">
                                    <h4 class="text-info mb-1" id="kpi-km">-</h4>
                                    <small class="text-muted">Kilometer</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-warning kpi-card">
                                <div class="card-body">
                                    <h4 class="text-warning mb-1" id="kpi-time">-</h4>
                                    <small class="text-muted">Zeit (Min)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-danger kpi-card">
                                <div class="card-body">
                                    <h4 class="text-danger mb-1" id="kpi-cost">-</h4>
                                    <small class="text-muted">Kosten</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-center border-secondary kpi-card">
                                <div class="card-body">
                                    <h4 class="text-secondary mb-1" id="kpi-avg-stops">-</h4>
                                    <small class="text-muted">Ø Stops/Tour</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Touren-Liste -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list"></i> Touren-Liste</h5>
                            <button class="btn btn-sm btn-primary" onclick="loadTourplanTours()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="tours-loading" class="text-center py-4">
                                <i class="fas fa-spinner fa-spin"></i> Lade Touren...
                            </div>
                            <div id="tours-content" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover tour-table">
                                        <thead>
                                            <tr>
                                                <th>Tour-ID</th>
                                                <th>Stops</th>
                                                <th>Distanz (km)</th>
                                                <th>Zeit (Min)</th>
                                                <th>Kosten (€)</th>
                                                <th>Fahrer</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tours-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tours-error" class="alert alert-danger" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Keine Daten -->
                <div id="no-data" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle"></i> Bitte wählen Sie einen Tourplan aus.
                </div>
            </div>
            
            <div class="tab-pane fade" id="db" role="tabpanel" aria-labelledby="db-tab">
                <h3 class="mb-4"><i class="fas fa-database"></i> Datenbank-Verwaltung</h3>
                
                <!-- Datenfluss-Visualisierung -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Datenfluss & System-Architektur</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Visualisierung des End-to-End-Datenflusses von der Tourenplanung bis zur KI-Auswertung.
                            <a href="/admin/dataflow.html" class="btn btn-sm btn-primary ms-2">
                                <i class="fas fa-project-diagram"></i> Vollständige Visualisierung öffnen
                            </a>
                            <a href="/docs/DATENFLUSS_ROUTEN_DB_KI_LEARNING.md" target="_blank" class="ms-2">
                                <i class="fas fa-external-link-alt"></i> Dokumentation
                            </a>
                        </p>
                        
                        <!-- Datenfluss-Diagramm -->
                        <div id="dataflow-diagram" class="dataflow-container">
                            <div class="text-center p-4">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">Lade Datenfluss-Visualisierung...</p>
                            </div>
                        </div>
                        
                        <!-- Status-Übersicht -->
                        <div class="row mt-4" id="dataflow-stats">
                            <div class="col-md-3">
                                <div class="card text-center border-primary">
                                    <div class="card-body">
                                        <h4 class="text-primary" id="stat-tours">-</h4>
                                        <small>Touren in DB</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center border-success">
                                    <div class="card-body">
                                        <h4 class="text-success" id="stat-stops">-</h4>
                                        <small>Tour-Stops</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center border-warning">
                                    <div class="card-body">
                                        <h4 class="text-warning" id="stat-events">-</h4>
                                        <small>Tour-Events</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center border-info">
                                    <div class="card-body">
                                        <h4 class="text-info" id="stat-embeddings">-</h4>
                                        <small>KI-Embeddings</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Batch Geocoding Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> Batch-Geocoding für Tourenpläne</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Laden Sie Tourenpläne hoch, lassen Sie die Adressen automatisch geocodieren und speichern Sie die Koordinaten direkt in die Datenbank.
                        </p>
                        
                        <!-- Upload-Bereich -->
                        <div class="mb-4">
                            <h6><i class="fas fa-upload"></i> Tourenpläne hochladen</h6>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" id="db-tourplan-upload" accept=".csv" multiple onchange="validateCSVFiles()">
                                <button class="btn btn-primary" type="button" onclick="uploadTourplansForGeocoding()" id="db-upload-button">
                                    <i class="fas fa-cloud-upload-alt"></i> Hochladen
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Mehrere CSV-Dateien möglich (max. 10 Dateien, je max. 50 MB). Die Adressen werden automatisch geocodiert und in die DB gespeichert.
                            </small>
                            <div id="csv-validation-message" class="mt-2" style="display: none;"></div>
                        </div>

                        <!-- Verfügbare Tourenpläne -->
                        <div class="mb-4">
                            <h6><i class="fas fa-list"></i> Verfügbare Tourenpläne</h6>
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="loadAvailableTourplans()">
                                    <i class="fas fa-sync"></i> Liste aktualisieren
                                </button>
                                <button class="btn btn-success btn-sm" onclick="geocodeAllTourplans()">
                                    <i class="fas fa-magic"></i> Alle geocodieren
                                </button>
                            </div>
                            <div id="tourplan-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle"></i> Klicken Sie auf "Liste aktualisieren" um verfügbare Tourenpläne zu laden
                                </div>
                            </div>
                        </div>

                        <!-- Geocoding Progress -->
                        <div id="geocoding-progress-container" style="display: none;">
                            <h6><i class="fas fa-tasks"></i> Geocoding-Fortschritt</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <span id="geocoding-progress-text">0 / 0</span>
                                    <span id="geocoding-progress-percent">0%</span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div id="geocoding-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                         role="progressbar" style="width: 0%">
                                    </div>
                                </div>
                            </div>
                            <div id="geocoding-status" class="alert alert-info">
                                <small>Bereit zum Starten...</small>
                            </div>
                            <div id="geocoding-results" class="mt-3" style="display: none;">
                                <h6>Ergebnisse:</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center border-success">
                                            <div class="card-body">
                                                <h3 class="text-success" id="geocoding-success-count">0</h3>
                                                <small>Erfolgreich</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-warning">
                                            <div class="card-body">
                                                <h3 class="text-warning" id="geocoding-skip-count">0</h3>
                                                <small>Übersprungen</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-danger">
                                            <div class="card-body">
                                                <h3 class="text-danger" id="geocoding-error-count">0</h3>
                                                <small>Fehler</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center border-info">
                                            <div class="card-body">
                                                <h3 class="text-info" id="geocoding-total-count">0</h3>
                                                <small>Gesamt</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DB-Info -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Datenbank-Informationen</h5>
                    </div>
                    <div class="card-body">
                        <div id="db-info-content">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i> Lade DB-Informationen...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary" onclick="loadDBInfo()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                            <a href="/docs/DB_SCHEMA_ADMIN.md" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="fas fa-book"></i> Schema-Dokumentation
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Tabellenliste -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-table"></i> Tabellen-Übersicht</h5>
                    </div>
                    <div class="card-body">
                        <div id="db-tables-content">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i> Lade Tabellen...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-secondary" onclick="loadDBTables()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabellen-Details -->
                <div class="card mb-4" id="table-details-card" style="display: none;">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Tabellen-Details: <span id="table-details-name"></span></h5>
                        <button class="btn btn-sm btn-light" onclick="closeTableDetails()">
                            <i class="fas fa-times"></i> Schließen
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="table-details-content">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i> Lade Details...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DB-Statistiken -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Datenbank-Statistiken</h5>
                    </div>
                    <div class="card-body">
                        <div id="db-stats" class="row">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-primary" id="db-customers-count">-</h4>
                                        <small>Kunden</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-success" id="db-geocoded-count">-</h4>
                                        <small>Geocodiert</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning" id="db-missing-count">-</h4>
                                        <small>Fehlend</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info" id="db-geocode-percent">-</h4>
                                        <small>Geocoding-Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-info btn-sm" onclick="loadDBStats()">
                                <i class="fas fa-sync"></i> Statistiken aktualisieren
                            </button>
                        </div>
                    </div>
                </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Navigation ist bereits direkt im HTML eingebettet, keine Initialisierung nötig
        
        // Health-Checks laden
        async function loadHealthChecks() {
            console.log('[HEALTH] Starte Health-Checks...');
            
            // App Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/app', { 
                    signal: AbortSignal.timeout(5000) // 5 Sekunden Timeout
                });
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-app-card');
                const content = document.getElementById('health-app-content');
                
                if (data.status === 'ok') {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: OK</div>
                        <div class="mt-2"><strong>Environment:</strong> ${data.env || 'unknown'}</div>
                        <div><strong>Feature Flags:</strong></div>
                        <ul class="small">
                            <li>Stats-Box: ${data.feature_flags?.stats_box_enabled ? '✅' : '❌'}</li>
                            <li>AI-Ops: ${data.feature_flags?.ai_ops_enabled ? '✅' : '❌'}</li>
                        </ul>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    content.innerHTML = `<div class="text-danger">Status: ERROR</div>`;
                }
            } catch (e) {
                document.getElementById('health-app-card').classList.add('health-error');
                document.getElementById('health-app-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // OSRM Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/osrm', { 
                    signal: AbortSignal.timeout(5000) // 5 Sekunden Timeout
                }).catch(err => {
                    console.warn('[HEALTH] OSRM Health-Check fehlgeschlagen:', err);
                    return null;
                });
                
                if (!response || !response.ok) {
                    // OSRM nicht erreichbar - zeige Warnung statt Fehler
                    const card = document.getElementById('health-osrm-card');
                    const content = document.getElementById('health-osrm-content');
                    if (card && content) {
                        card.className = 'card border-warning';
                        content.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>OSRM nicht erreichbar</strong><br>
                                <small>Bitte prüfen Sie, ob Docker Desktop läuft und OSRM gestartet ist.</small>
                            </div>
                        `;
                    }
                    return;
                }
                
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-osrm-card');
                const content = document.getElementById('health-osrm-content');
                
                // Prüfe data.ok (nicht data.status)
                if (data.ok === true || data.status === 'up' || data.status === 'ok') {
                    card.classList.add('health-ok');
                    card.classList.remove('health-error', 'health-warning');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: OK</div>
                        <div class="mt-2"><strong>URL:</strong> ${data.url || 'unknown'}</div>
                        <div><strong>Status:</strong> ${data.status || 'unknown'}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    card.classList.remove('health-ok', 'health-warning');
                    const errorMsg = data.error || data.message || 'Unknown error';
                    content.innerHTML = `
                        <div class="text-danger"><i class="fas fa-times-circle"></i> Status: ERROR</div>
                        <div class="mt-2"><strong>URL:</strong> ${data.url || 'unknown'}</div>
                        <div class="mt-2"><strong>Fehler:</strong> ${errorMsg}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-osrm-card').classList.add('health-error');
                document.getElementById('health-osrm-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // DB Health
            try {
                const startTime = performance.now();
                const response = await fetch('/health/db', { 
                    signal: AbortSignal.timeout(5000) // 5 Sekunden Timeout
                });
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-db-card');
                const content = document.getElementById('health-db-content');
                
                if (data.status === 'online') {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Status: Online</div>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-error');
                    content.innerHTML = `
                        <div class="text-danger"><i class="fas fa-times-circle"></i> Status: Offline</div>
                        <div class="mt-2"><strong>Error:</strong> ${data.error || 'Unknown'}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-db-card').classList.add('health-error');
                document.getElementById('health-db-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }

            // OSRM Sample Route
            try {
                const startTime = performance.now();
                const response = await fetch('/health/osrm/sample-route', { 
                    signal: AbortSignal.timeout(10000) // 10 Sekunden Timeout (kann länger dauern)
                }).catch(err => {
                    console.warn('[HEALTH] OSRM Sample-Route-Check fehlgeschlagen:', err);
                    return null;
                });
                
                if (!response || !response.ok) {
                    // OSRM Sample-Route nicht verfügbar - zeige Warnung statt Fehler
                    const card = document.getElementById('health-osrm-sample-card');
                    const content = document.getElementById('health-osrm-sample-content');
                    if (card && content) {
                        card.className = 'card border-warning';
                        content.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>OSRM Sample-Route nicht verfügbar</strong><br>
                                <small>OSRM-Service ist möglicherweise nicht gestartet oder nicht erreichbar.</small>
                            </div>
                        `;
                    }
                    return;
                }
                
                const latency = Math.round(performance.now() - startTime);
                const data = await response.json();
                
                const card = document.getElementById('health-osrm-sample-card');
                const content = document.getElementById('health-osrm-sample-content');
                
                if (data.ok) {
                    card.classList.add('health-ok');
                    content.innerHTML = `
                        <div class="text-success"><i class="fas fa-check-circle"></i> Polyline6 verfügbar</div>
                        <div class="mt-2"><strong>Polyline-Länge:</strong> ${data.polyline6_len || 0} Zeichen</div>
                        <div><strong>Status:</strong> ${data.status || 'unknown'}</div>
                        <div class="latency">Latenz: ${data.latency_ms || latency}ms</div>
                    `;
                } else {
                    card.classList.add('health-warning');
                    content.innerHTML = `
                        <div class="text-warning"><i class="fas fa-exclamation-triangle"></i> Polyline6 nicht verfügbar</div>
                        <div class="mt-2"><strong>Error:</strong> ${data.error || 'Unknown'}</div>
                        <div class="latency">Latenz: ${latency}ms</div>
                    `;
                }
            } catch (e) {
                document.getElementById('health-osrm-sample-card').classList.add('health-error');
                document.getElementById('health-osrm-sample-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }
            
            // Workflow Engine Status
            try {
                const workflowResponse = await fetch('/api/workflow/status', { 
                    signal: AbortSignal.timeout(5000) 
                });
                const workflowData = await workflowResponse.json();
                const workflowContent = document.getElementById('health-workflow-content');
                
                if (workflowResponse.ok) {
                    const llmStatus = workflowData.llm_status || 'unknown';
                    const llmModel = workflowData.llm_model || 'N/A';
                    const optimizer = workflowData.optimizer || 'N/A';
                    
                    workflowContent.innerHTML = `
                        <div><i class="fas fa-check-circle text-success"></i> <strong>Status:</strong> Verfügbar</div>
                        <div class="mt-2"><strong>Optimizer:</strong> ${escapeHtml(optimizer)}</div>
                        <div><strong>LLM-Status:</strong> <span class="badge ${llmStatus === 'ok' ? 'bg-success' : 'bg-warning'}">${escapeHtml(llmStatus)}</span></div>
                        <div><strong>LLM-Modell:</strong> ${escapeHtml(llmModel)}</div>
                    `;
                } else {
                    workflowContent.innerHTML = `<div class="text-danger">Fehler: ${workflowData.detail || 'Unbekannt'}</div>`;
                }
            } catch (e) {
                document.getElementById('health-workflow-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }
            
            // LLM Integration Status
            try {
                const llmResponse = await fetch('/api/llm/monitoring', { 
                    signal: AbortSignal.timeout(5000) 
                });
                const llmData = await llmResponse.json();
                const llmContent = document.getElementById('health-llm-content');
                
                if (llmResponse.ok) {
                    const status = llmData.status || 'unknown';
                    const model = llmData.model || 'N/A';
                    const calls = llmData.total_calls || 0;
                    const errors = llmData.total_errors || 0;
                    
                    llmContent.innerHTML = `
                        <div><i class="fas fa-check-circle text-success"></i> <strong>Status:</strong> <span class="badge ${status === 'ok' ? 'bg-success' : 'bg-warning'}">${escapeHtml(status)}</span></div>
                        <div class="mt-2"><strong>Modell:</strong> ${escapeHtml(model)}</div>
                        <div><strong>API-Calls:</strong> ${calls}</div>
                        <div><strong>Fehler:</strong> ${errors}</div>
                    `;
                } else {
                    llmContent.innerHTML = `<div class="text-warning">LLM-Monitoring nicht verfügbar</div>`;
                }
            } catch (e) {
                document.getElementById('health-llm-content').innerHTML = `<div class="text-warning">LLM-Status nicht verfügbar</div>`;
            }
            
            // Systemregeln Status
            try {
                const rulesResponse = await fetch('/api/system/rules', { 
                    signal: AbortSignal.timeout(5000) 
                });
                const rulesData = await rulesResponse.json();
                const rulesContent = document.getElementById('health-system-rules-content');
                
                if (rulesResponse.ok) {
                    const source = rulesData.source || 'unknown';
                    const timeBudget = rulesData.time_budget_without_return || 'N/A';
                    
                    rulesContent.innerHTML = `
                        <div><i class="fas fa-check-circle text-success"></i> <strong>Status:</strong> Verfügbar</div>
                        <div class="mt-2"><strong>Quelle:</strong> ${escapeHtml(source)}</div>
                        <div><strong>Zeitbudget:</strong> ${timeBudget} Min (ohne Rückfahrt)</div>
                    `;
                } else {
                    rulesContent.innerHTML = `<div class="text-warning">Systemregeln nicht verfügbar</div>`;
                }
            } catch (e) {
                document.getElementById('health-system-rules-content').innerHTML = `<div class="text-warning">Systemregeln-Status nicht verfügbar</div>`;
            }
            
            // Gesamt-Status (kombiniert)
            try {
                const combinedResponse = await fetch('/health/status');
                const combinedData = await combinedResponse.json();
                const combinedContent = document.getElementById('health-combined-content');
                
                if (combinedResponse.ok) {
                    const overallStatus = combinedData.status || 'unknown';
                    const services = combinedData.services || {};
                    
                    const statusIcon = overallStatus === 'ok' ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning';
                    const statusBadge = overallStatus === 'ok' ? 'bg-success' : 'bg-warning';
                    
                    let servicesHtml = '<div class="mt-2"><small>';
                    for (const [service, info] of Object.entries(services)) {
                        const serviceStatus = info.status || 'unknown';
                        const serviceIcon = serviceStatus === 'ok' ? 'fa-check text-success' : 'fa-times text-danger';
                        servicesHtml += `<div><i class="fas ${serviceIcon}"></i> ${service}: ${escapeHtml(info.message || 'N/A')}</div>`;
                    }
                    servicesHtml += '</small></div>';
                    
                    combinedContent.innerHTML = `
                        <div><i class="fas ${statusIcon}"></i> <strong>Gesamt-Status:</strong> <span class="badge ${statusBadge}">${escapeHtml(overallStatus.toUpperCase())}</span></div>
                        ${servicesHtml}
                    `;
                } else {
                    combinedContent.innerHTML = `<div class="text-danger">Fehler beim Abrufen des Gesamt-Status</div>`;
                }
            } catch (e) {
                document.getElementById('health-combined-content').innerHTML = `<div class="text-danger">Fehler: ${e.message}</div>`;
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        // Chart-Instanzen
        let toursChart = null;
        let stopsChart = null;
        let kmChart = null;
        let delayScoreChart = null;

        // Statistiken laden
        async function loadStats() {
            const period = document.getElementById('stats-period').value;
            const count = parseInt(document.getElementById('stats-count').value);
            const loadingEl = document.getElementById('stats-loading');
            const contentEl = document.getElementById('stats-content');
            const errorEl = document.getElementById('stats-error');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            try {
                const endpoint = period === 'daily' ? '/api/stats/daily' : '/api/stats/monthly';
                const param = period === 'daily' ? 'days' : 'months';
                const response = await fetch(`${endpoint}?${param}=${count}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const stats = period === 'daily' ? data.days : data.months;

                if (!stats || stats.length === 0) {
                    throw new Error('Keine Daten verfügbar');
                }

                // Charts aktualisieren
                updateCharts(stats, period);
                
                // KPI-Boxen aktualisieren
                updateKPIBoxes(stats);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                loadingEl.style.display = 'none';
                errorEl.textContent = `Fehler beim Laden der Statistiken: ${e.message}`;
                errorEl.style.display = 'block';
            }
        }

        // KPI-Boxen aktualisieren
        function updateKPIBoxes(stats) {
            if (!stats || stats.length === 0) return;
            
            // Aggregiere über alle Perioden
            const totalTours = stats.reduce((sum, s) => sum + (s.tours || 0), 0);
            const totalKm = stats.reduce((sum, s) => sum + (s.km || 0), 0);
            const totalStops = stats.reduce((sum, s) => sum + (s.stops || 0), 0);
            const avgStops = totalTours > 0 ? (totalStops / totalTours).toFixed(1) : '0.0';
            const avgDelay = stats.reduce((sum, s) => sum + (s.avg_delay_minutes || 0), 0) / stats.length;
            const avgScore = stats.reduce((sum, s) => sum + (s.avg_success_score || 0), 0) / stats.length;
            const totalAborted = stats.reduce((sum, s) => sum + (s.aborted_tours || 0), 0);
            const abortRate = totalTours > 0 ? ((totalAborted / totalTours) * 100).toFixed(1) : '0.0';
            
            document.getElementById('kpi-tours').textContent = totalTours;
            document.getElementById('kpi-km').textContent = totalKm.toFixed(0) + ' km';
            document.getElementById('kpi-avg-stops').textContent = avgStops;
            document.getElementById('kpi-avg-delay').textContent = avgDelay > 0 ? avgDelay.toFixed(1) + ' min' : '-';
            document.getElementById('kpi-avg-score').textContent = avgScore > 0 ? avgScore.toFixed(1) : '-';
            document.getElementById('kpi-abort-rate').textContent = abortRate + ' %';
        }
        
        // Charts aktualisieren
        function updateCharts(stats, period) {
            const labelKey = period === 'daily' ? 'date' : 'month';
            const labels = stats.map(s => s[labelKey]).reverse();
            const toursData = stats.map(s => s.tours).reverse();
            const stopsData = stats.map(s => s.stops).reverse();
            const kmPlannedData = stats.map(s => s.km_planned || s.km || 0).reverse();
            const kmRealData = stats.map(s => s.km_real || s.km || 0).reverse();
            const delayData = stats.map(s => s.avg_delay_minutes || 0).reverse();
            const scoreData = stats.map(s => s.avg_success_score || 0).reverse();

            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            };

            // Touren-Chart
            if (toursChart) toursChart.destroy();
            toursChart = new Chart(document.getElementById('chart-tours'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Touren',
                        data: toursData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                }
            });

            // Stops-Chart
            if (stopsChart) stopsChart.destroy();
            stopsChart = new Chart(document.getElementById('chart-stops'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stops',
                        data: stopsData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                }
            });

            // KM-Chart (geplant vs. real)
            if (kmChart) kmChart.destroy();
            kmChart = new Chart(document.getElementById('chart-km'), {
                ...chartConfig,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Geplant',
                        data: kmPlannedData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Real',
                        data: kmRealData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                }
            });

            // Verspätung & Score Chart
            if (delayScoreChart) delayScoreChart.destroy();
            delayScoreChart = new Chart(document.getElementById('chart-delay-score'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø Verspätung (min)',
                        data: delayData,
                        backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        borderColor: 'rgb(255, 206, 86)',
                        yAxisID: 'y'
                    }, {
                        label: 'Ø Success-Score',
                        data: scoreData,
                        type: 'line',
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        yAxisID: 'y1',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Verspätung (min)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score (0-100)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Export-Funktion
        function exportStats(format) {
            const period = document.getElementById('stats-period').value;
            const count = parseInt(document.getElementById('stats-count').value);
            const url = `/api/stats/export/${format}?period=${period}&count=${count}`;
            // Öffne Download-Link in neuem Tab
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Auth-Check beim Laden der Seite
        (async () => {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (data.authenticated) {
                    // Authentifiziert: Zeige Admin-Inhalt
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('loginRequired').style.display = 'none';
                    document.getElementById('logoutLink').style.display = 'block';
                    
                    // Logout-Handler
                    document.getElementById('logoutLink').addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            await fetch('/api/auth/logout', { method: 'POST' });
                            window.location.href = '/admin/login.html';
                        } catch (error) {
                            console.error('Logout-Fehler:', error);
                        }
                    });
                } else {
                    // Nicht authentifiziert: Zeige Login-Hinweis
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('loginRequired').style.display = 'block';
                    document.getElementById('logoutLink').style.display = 'none';
                }
            } catch (error) {
                console.error('Auth-Check Fehler:', error);
                // Bei Fehler: Zeige Login-Hinweis
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
            }
        })();
        
        // Beim Laden: Health-Checks ausführen
        document.addEventListener('DOMContentLoaded', () => {
            loadHealthChecks();
            // Alle 30 Sekunden aktualisieren
            setInterval(loadHealthChecks, 30000);
            
            // Beim DB-Tab-Wechsel Datenfluss-Visualisierung und DB-Info laden
            const dbTab = document.getElementById('db-tab');
            if (dbTab) {
                // Beim ersten Öffnen des Tabs
                dbTab.addEventListener('shown.bs.tab', () => {
                    console.log('[DATAFLOW] DB-Tab geöffnet, lade Visualisierung...');
                    const dbTabPane = document.getElementById('db');
                    if (dbTabPane) {
                        // WICHTIG: Bootstrap benötigt 'show' Klasse für opacity: 1
                        dbTabPane.classList.add('show', 'active');
                        // Force visibility
                        dbTabPane.style.display = 'block';
                        dbTabPane.style.opacity = '1';
                        dbTabPane.style.visibility = 'visible';
                    }
                    console.log('[DB-TAB] Tab-Pane gefunden:', !!dbTabPane, 'Aktiv:', dbTabPane?.classList.contains('active'), 'Show:', dbTabPane?.classList.contains('show'));
                    // Warte kurz, damit der Tab-Inhalt sichtbar ist
                    setTimeout(() => {
                        console.log('[DB-TAB] Starte Ladevorgang...');
                        renderDataflowDiagram();
                        loadDataflowStats();
                        loadDBInfo();
                        loadDBTables();
                    }, 100);
                });
                
                // Prüfe ob DB-Tab bereits aktiv ist (z.B. beim direkten Aufruf)
                const dbTabPane = document.getElementById('db');
                if (dbTabPane && dbTabPane.classList.contains('active')) {
                    // WICHTIG: Bootstrap benötigt 'show' Klasse für opacity: 1
                    dbTabPane.classList.add('show');
                    dbTabPane.style.display = 'block';
                    dbTabPane.style.opacity = '1';
                    dbTabPane.style.visibility = 'visible';
                    console.log('[DB-TAB] Tab bereits aktiv beim Laden, show-Klasse hinzugefügt');
                    setTimeout(() => {
                        renderDataflowDiagram();
                        loadDataflowStats();
                        loadDBInfo();
                        loadDBTables();
                    }, 200);
                }
            }
            
            // Beim Tab-Wechsel Statistiken laden
            const statsTab = document.getElementById('stats-tab');
            if (statsTab) {
                statsTab.addEventListener('shown.bs.tab', () => {
                    loadStats();
                });
            }
            
            // Beim Tab-Wechsel Systemregeln laden
            const rulesTab = document.getElementById('rules-tab');
            if (rulesTab) {
                rulesTab.addEventListener('shown.bs.tab', () => {
                    loadSystemRules();
                });
            }
            
            // Formular-Handler registrieren
            const form = document.getElementById('system-rules-form');
            if (form) {
                form.addEventListener('submit', saveSystemRules);
            }
        });
        
        // Lade Systemregeln vom Backend
        async function loadSystemRules() {
            try {
                // Lade aktuelle Werte vom Backend
                const response = await fetch('/api/system/rules');
                const data = await response.json();
                
                // Aktualisiere alle Platzhalter
                const timeWithoutReturn = data.time_budget_without_return || 65;
                const timeWithReturn = data.time_budget_with_return || 90;
                const serviceTime = data.service_time_per_stop || 2;
                const speedKmh = data.speed_kmh || 50;
                const safetyFactor = data.safety_factor || 1.3;
                const depotCoords = data.depot_coords || '51.0111988, 13.7016485';
                
                // Aktualisiere alle Elemente
                document.querySelectorAll('#time-budget-without-return, #time-budget-without-return-2, #time-budget-without-return-3, #time-budget-without-return-4, #time-budget-without-return-5, #time-budget-without-return-6, #time-budget-without-return-7, #time-budget-without-return-8').forEach(el => {
                    if (el) el.textContent = timeWithoutReturn;
                });
                document.querySelectorAll('#time-budget-with-return, #time-budget-with-return-2').forEach(el => {
                    if (el) el.textContent = timeWithReturn;
                });
                const serviceTimeEl = document.getElementById('service-time-per-stop');
                if (serviceTimeEl) serviceTimeEl.textContent = serviceTime;
                const speedEl = document.getElementById('speed-kmh');
                if (speedEl) speedEl.textContent = speedKmh;
                document.querySelectorAll('#safety-factor, #safety-factor-2').forEach(el => {
                    if (el) el.textContent = safetyFactor;
                });
                const depotEl = document.getElementById('depot-coords');
                if (depotEl) depotEl.textContent = depotCoords;
                
                // Fülle Edit-Formular
                const editTimeWithoutReturn = document.getElementById('edit-time-budget-without-return');
                if (editTimeWithoutReturn) editTimeWithoutReturn.value = timeWithoutReturn;
                const editTimeWithReturn = document.getElementById('edit-time-budget-with-return');
                if (editTimeWithReturn) editTimeWithReturn.value = timeWithReturn;
                const editServiceTime = document.getElementById('edit-service-time-per-stop');
                if (editServiceTime) editServiceTime.value = serviceTime;
                const editSpeed = document.getElementById('edit-speed-kmh');
                if (editSpeed) editSpeed.value = speedKmh;
                const editSafetyFactor = document.getElementById('edit-safety-factor');
                if (editSafetyFactor) editSafetyFactor.value = safetyFactor;
                const editDepotLat = document.getElementById('edit-depot-lat');
                if (editDepotLat) editDepotLat.value = data.depot_lat || 51.0111988;
                const editDepotLon = document.getElementById('edit-depot-lon');
                if (editDepotLon) editDepotLon.value = data.depot_lon || 13.7016485;
            } catch (error) {
                console.error('Fehler beim Laden der Systemregeln:', error);
                // Verwende Standardwerte wenn API nicht verfügbar
            }
        }
        
        // Systemregeln speichern
        async function saveSystemRules(event) {
            event.preventDefault();
            const messageDiv = document.getElementById('rules-save-message');
            messageDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Speichere...</div>';
            
            try {
                const rules = {
                    time_budget_without_return: parseInt(document.getElementById('edit-time-budget-without-return').value),
                    time_budget_with_return: parseInt(document.getElementById('edit-time-budget-with-return').value),
                    service_time_per_stop: parseFloat(document.getElementById('edit-service-time-per-stop').value),
                    speed_kmh: parseFloat(document.getElementById('edit-speed-kmh').value),
                    safety_factor: parseFloat(document.getElementById('edit-safety-factor').value),
                    depot_lat: parseFloat(document.getElementById('edit-depot-lat').value),
                    depot_lon: parseFloat(document.getElementById('edit-depot-lon').value)
                };
                
                // Validiere Werte vor dem Senden
                if (isNaN(rules.time_budget_without_return) || rules.time_budget_without_return < 1 || rules.time_budget_without_return > 120) {
                    throw new Error('Zeitbudget ohne Rückfahrt muss zwischen 1 und 120 Minuten liegen');
                }
                if (isNaN(rules.time_budget_with_return) || rules.time_budget_with_return < 1 || rules.time_budget_with_return > 180) {
                    throw new Error('Zeitbudget mit Rückfahrt muss zwischen 1 und 180 Minuten liegen');
                }
                if (isNaN(rules.service_time_per_stop) || rules.service_time_per_stop < 0.5 || rules.service_time_per_stop > 10.0) {
                    throw new Error('Service-Zeit pro Stop muss zwischen 0.5 und 10.0 Minuten liegen');
                }
                if (isNaN(rules.speed_kmh) || rules.speed_kmh < 10 || rules.speed_kmh > 100) {
                    throw new Error('Geschwindigkeit muss zwischen 10 und 100 km/h liegen');
                }
                if (isNaN(rules.safety_factor) || rules.safety_factor < 1.0 || rules.safety_factor > 2.0) {
                    throw new Error('Sicherheitsfaktor muss zwischen 1.0 und 2.0 liegen');
                }
                if (isNaN(rules.depot_lat) || rules.depot_lat < -90 || rules.depot_lat > 90) {
                    throw new Error('Depot-Latitude muss zwischen -90 und 90 liegen');
                }
                if (isNaN(rules.depot_lon) || rules.depot_lon < -180 || rules.depot_lon > 180) {
                    throw new Error('Depot-Longitude muss zwischen -180 und 180 liegen');
                }
                
                const response = await fetch('/api/system/rules', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',  // Wichtig: Cookies mitsenden
                    body: JSON.stringify(rules)
                });
                
                if (!response.ok) {
                    let errorMessage = 'Fehler beim Speichern';
                    let errorDetails = [];
                    
                    try {
                        const errorData = await response.json();
                        
                        // Pydantic Validation Errors (422)
                        if (errorData.detail) {
                            if (Array.isArray(errorData.detail)) {
                                errorDetails = errorData.detail.map(e => ({
                                    field: e.loc.join('.'),
                                    message: e.msg
                                }));
                                errorMessage = errorDetails.map(e => `${e.field}: ${e.message}`).join(', ');
                            } else {
                                errorMessage = errorData.detail;
                            }
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                        
                        // Strukturierte Fehlermeldung für Frontend
                        if (response.status === 401) {
                            errorMessage = 'Authentifizierung erforderlich. Bitte melden Sie sich an.';
                        } else if (response.status === 422) {
                            errorMessage = 'Validierungsfehler: ' + errorMessage;
                        } else if (response.status === 500) {
                            errorMessage = 'Server-Fehler: ' + errorMessage;
                        }
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // Zeige detaillierte Fehlermeldung
                    if (errorDetails.length > 0) {
                        const detailsHtml = errorDetails.map(e => 
                            `<li><strong>${e.field}:</strong> ${e.message}</li>`
                        ).join('');
                        throw new Error(`<strong>Validierungsfehler:</strong><ul class="mb-0">${detailsHtml}</ul>`);
                    } else {
                        throw new Error(errorMessage);
                    }
                }
                
                const result = await response.json();
                messageDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Systemregeln erfolgreich gespeichert!</div>';
                
                // Aktualisiere Anzeige
                setTimeout(() => {
                    loadSystemRules();
                }, 500);
            } catch (error) {
                console.error('Fehler beim Speichern der Systemregeln:', error);
                
                // Prüfe ob Fehlermeldung HTML enthält (strukturierte Validierungsfehler)
                const isHtml = error.message && error.message.includes('<');
                const errorContent = isHtml ? error.message : (error.message || 'Unbekannter Fehler');
                
                messageDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Fehler:</strong> ${errorContent}</div>`;
            }
        }
        
        // Formular zurücksetzen (lädt aktuelle Werte)
        function resetSystemRulesForm() {
            loadSystemRules();
            const messageDiv = document.getElementById('rules-save-message');
            if (messageDiv) messageDiv.innerHTML = '';
        }
        
        // Auf Standard-Werte zurücksetzen
        function resetToDefaults() {
            if (!confirm('Möchten Sie wirklich alle Werte auf die Standard-Werte zurücksetzen?')) {
                return;
            }
            
            // Standard-Werte
            document.getElementById('edit-time-budget-without-return').value = 65;
            document.getElementById('edit-time-budget-with-return').value = 90;
            document.getElementById('edit-service-time-per-stop').value = 2.0;
            document.getElementById('edit-speed-kmh').value = 50;
            document.getElementById('edit-safety-factor').value = 1.3;
            document.getElementById('edit-depot-lat').value = 51.0111988;
            document.getElementById('edit-depot-lon').value = 13.7016485;
            
            const messageDiv = document.getElementById('rules-save-message');
            if (messageDiv) {
                messageDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Werte auf Standard zurückgesetzt. Bitte auf "Speichern" klicken, um zu übernehmen.</div>';
            }
        }
        // ===== DATENFLUSS-VISUALISIERUNG =====
        
        function renderDataflowDiagram() {
            const container = document.getElementById('dataflow-diagram');
            if (!container) {
                console.warn('[DATAFLOW] Container dataflow-diagram nicht gefunden');
                return;
            }
            
            console.log('[DATAFLOW] Rendere Diagramm...');
            
            // SVG-basierte Flowchart-Visualisierung
            const svg = `
                <svg viewBox="0 0 1200 600" class="dataflow-svg">
                    <!-- Hintergrund -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#007bff" />
                        </marker>
                        <linearGradient id="phase1" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#e3f2fd;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#bbdefb;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="phase2" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#fff3e0;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffe0b2;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="phase3" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#f3e5f5;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e1bee7;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="phase4" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#e8f5e9;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c8e6c9;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Phase 1: Planung & CSV-Import -->
                    <g class="phase-group" data-phase="1">
                        <rect x="50" y="50" width="200" height="120" rx="10" fill="url(#phase1)" stroke="#1976d2" stroke-width="2"/>
                        <text x="150" y="90" text-anchor="middle" font-size="16" font-weight="bold" fill="#1565c0">Phase 1</text>
                        <text x="150" y="110" text-anchor="middle" font-size="12" fill="#1565c0">CSV-Import</text>
                        <text x="150" y="130" text-anchor="middle" font-size="12" fill="#1565c0">Parsing &amp; Geocoding</text>
                        <text x="150" y="150" text-anchor="middle" font-size="12" fill="#1565c0">OSRM-Routing</text>
                    </g>
                    
                    <!-- Pfeil 1 -->
                    <line x1="250" y1="110" x2="300" y2="110" stroke="#007bff" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Phase 2: Durchführung -->
                    <g class="phase-group" data-phase="2">
                        <rect x="300" y="50" width="200" height="120" rx="10" fill="url(#phase2)" stroke="#f57c00" stroke-width="2"/>
                        <text x="400" y="90" text-anchor="middle" font-size="16" font-weight="bold" fill="#e65100">Phase 2</text>
                        <text x="400" y="110" text-anchor="middle" font-size="12" fill="#e65100">Tour-Durchführung</text>
                        <text x="400" y="130" text-anchor="middle" font-size="12" fill="#e65100">Ist-Daten sammeln</text>
                        <text x="400" y="150" text-anchor="middle" font-size="12" fill="#e65100">Events &amp; Abweichungen</text>
                    </g>
                    
                    <!-- Pfeil 2 -->
                    <line x1="500" y1="110" x2="550" y2="110" stroke="#007bff" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Phase 3: Speicherung -->
                    <g class="phase-group" data-phase="3">
                        <rect x="550" y="50" width="200" height="120" rx="10" fill="url(#phase3)" stroke="#7b1fa2" stroke-width="2"/>
                        <text x="650" y="90" text-anchor="middle" font-size="16" font-weight="bold" fill="#6a1b9a">Phase 3</text>
                        <text x="650" y="110" text-anchor="middle" font-size="12" fill="#6a1b9a">DB-Speicherung</text>
                        <text x="650" y="130" text-anchor="middle" font-size="12" fill="#6a1b9a">tours, tour_stops</text>
                        <text x="650" y="150" text-anchor="middle" font-size="12" fill="#6a1b9a">tour_events</text>
                    </g>
                    
                    <!-- Pfeil 3 (nach unten) -->
                    <line x1="650" y1="170" x2="650" y2="250" stroke="#007bff" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Phase 4: KI-Auswertung -->
                    <g class="phase-group" data-phase="4">
                        <rect x="550" y="250" width="200" height="120" rx="10" fill="url(#phase4)" stroke="#388e3c" stroke-width="2"/>
                        <text x="650" y="290" text-anchor="middle" font-size="16" font-weight="bold" fill="#2e7d32">Phase 4</text>
                        <text x="650" y="310" text-anchor="middle" font-size="12" fill="#2e7d32">KI-Auswertung</text>
                        <text x="650" y="330" text-anchor="middle" font-size="12" fill="#2e7d32">Embedding-Erzeugung</text>
                        <text x="650" y="350" text-anchor="middle" font-size="12" fill="#2e7d32">Vektor-DB</text>
                    </g>
                    
                    <!-- Pfeil 4 (zurück nach links) -->
                    <line x1="550" y1="310" x2="300" y2="310" stroke="#007bff" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="425" y="300" text-anchor="middle" font-size="10" fill="#666">KI-Vorschläge</text>
                    
                    <!-- Datenbank-Symbole -->
                    <g class="db-symbol" data-db="tours">
                        <ellipse cx="700" cy="200" rx="40" ry="20" fill="#fff" stroke="#7b1fa2" stroke-width="2"/>
                        <text x="700" y="205" text-anchor="middle" font-size="10" fill="#7b1fa2">tours</text>
                    </g>
                    <g class="db-symbol" data-db="stops">
                        <ellipse cx="750" cy="200" rx="40" ry="20" fill="#fff" stroke="#7b1fa2" stroke-width="2"/>
                        <text x="750" y="205" text-anchor="middle" font-size="10" fill="#7b1fa2">stops</text>
                    </g>
                    <g class="db-symbol" data-db="events">
                        <ellipse cx="800" cy="200" rx="40" ry="20" fill="#fff" stroke="#7b1fa2" stroke-width="2"/>
                        <text x="800" y="205" text-anchor="middle" font-size="10" fill="#7b1fa2">events</text>
                    </g>
                    <g class="db-symbol" data-db="embeddings">
                        <ellipse cx="700" cy="400" rx="50" ry="20" fill="#fff" stroke="#388e3c" stroke-width="2"/>
                        <text x="700" y="405" text-anchor="middle" font-size="10" fill="#388e3c">embeddings</text>
                    </g>
                    
                    <!-- Verbindungslinien zu DB -->
                    <line x1="650" y1="120" x2="700" y2="200" stroke="#9c27b0" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="650" y1="120" x2="750" y2="200" stroke="#9c27b0" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="650" y1="120" x2="800" y2="200" stroke="#9c27b0" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="650" y1="310" x2="700" y2="400" stroke="#4caf50" stroke-width="2" stroke-dasharray="5,5"/>
                </svg>
            `;
            
            container.innerHTML = svg;
            console.log('[DATAFLOW] Diagramm gerendert');
        }
        
        async function loadDataflowStats() {
            try {
                // Lade Statistiken aus der Datenbank
                const response = await fetch('/api/db/stats');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('stat-tours').textContent = data.tours_count || 0;
                    document.getElementById('stat-stops').textContent = data.stops_count || 0;
                    document.getElementById('stat-events').textContent = data.events_count || 0;
                    document.getElementById('stat-embeddings').textContent = data.embeddings_count || 0;
                } else {
                    // Fallback: Zeige "-" wenn API nicht verfügbar
                    document.getElementById('stat-tours').textContent = '-';
                    document.getElementById('stat-stops').textContent = '-';
                    document.getElementById('stat-events').textContent = '-';
                    document.getElementById('stat-embeddings').textContent = '-';
                }
            } catch (e) {
                console.warn('Fehler beim Laden der Datenfluss-Statistiken:', e);
            }
        }
        
        // ===== DB-VERWALTUNG FUNKTIONEN =====
        
        // Validiere CSV-Dateien
        function validateCSVFiles() {
            const fileInput = document.getElementById('db-tourplan-upload');
            const files = fileInput.files;
            const messageDiv = document.getElementById('csv-validation-message');
            const uploadButton = document.getElementById('db-upload-button');
            
            // Reset
            messageDiv.style.display = 'none';
            messageDiv.className = 'mt-2';
            uploadButton.disabled = false;
            
            if (files.length === 0) {
                return;
            }
            
            // Prüfe Anzahl
            if (files.length > 10) {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-danger';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Maximal 10 Dateien erlaubt!';
                uploadButton.disabled = true;
                return;
            }
            
            // Prüfe Dateigröße und -typ
            const maxSize = 50 * 1024 * 1024; // 50 MB
            let errors = [];
            
            for (let file of files) {
                // Prüfe Dateityp
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    errors.push(`${file.name}: Nur CSV-Dateien erlaubt`);
                }
                
                // Prüfe Größe
                if (file.size > maxSize) {
                    errors.push(`${file.name}: Datei zu groß (max. 50 MB)`);
                }
                
                // Prüfe Leer-Datei
                if (file.size === 0) {
                    errors.push(`${file.name}: Datei ist leer`);
                }
            }
            
            if (errors.length > 0) {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-danger';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Validierung fehlgeschlagen:</strong><ul class="mb-0">' +
                    errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                uploadButton.disabled = true;
            } else {
                messageDiv.style.display = 'block';
                messageDiv.className = 'mt-2 alert alert-success';
                messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${files.length} Datei(en) bereit zum Hochladen`;
            }
        }
        
        // Tourenpläne hochladen und geocodieren
        async function uploadTourplansForGeocoding() {
            const fileInput = document.getElementById('db-tourplan-upload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Bitte wählen Sie mindestens eine CSV-Datei aus.');
                return;
            }
            
            // Nochmal validieren
            if (files.length > 10) {
                alert('Maximal 10 Dateien erlaubt!');
                return;
            }
            
            // Zeige Progress-Container
            document.getElementById('geocoding-progress-container').style.display = 'block';
            document.getElementById('geocoding-results').style.display = 'none';
            
            let totalSuccess = 0;
            let totalSkip = 0;
            let totalError = 0;
            let totalProcessed = 0;
            let totalCustomers = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateGeocodingStatus(`Verarbeite ${file.name} (${i + 1}/${files.length})...`, 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Upload und Geocoding
                    const response = await fetch('/api/tourplan/batch-geocode', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        totalError++;
                        updateGeocodingStatus(`Fehler bei ${file.name}: HTTP ${response.status}`, 'danger');
                        continue;
                    }
                    
                    const result = await response.json();
                    
                    // Aktualisiere Zähler
                    totalSuccess += result.geocoded_count || 0;
                    totalSkip += result.skipped_count || 0;
                    totalError += result.error_count || 0;
                    totalCustomers += result.total_customers || 0;
                    totalProcessed++;
                    
                    // Aktualisiere Progress
                    const progress = ((i + 1) / files.length) * 100;
                    updateGeocodingProgress(i + 1, files.length, progress);
                    
                } catch (error) {
                    totalError++;
                    updateGeocodingStatus(`Fehler bei ${file.name}: ${error.message}`, 'danger');
                }
            }
            
            // Zeige Ergebnisse
            document.getElementById('geocoding-results').style.display = 'block';
            document.getElementById('geocoding-success-count').textContent = totalSuccess;
            document.getElementById('geocoding-skip-count').textContent = totalSkip;
            document.getElementById('geocoding-error-count').textContent = totalError;
            document.getElementById('geocoding-total-count').textContent = totalCustomers;
            
            updateGeocodingStatus(`Abgeschlossen: ${totalProcessed} von ${files.length} Dateien verarbeitet`, 'success');
            
            // Lade DB-Statistiken neu
            loadDBStats();
            loadAvailableTourplans();
            
            // Reset File Input
            fileInput.value = '';
        }
        
        // Lade verfügbare Tourenpläne
        async function loadAvailableTourplans() {
            const listDiv = document.getElementById('tourplan-list');
            listDiv.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Lade...</div>';
            
            try {
                const response = await fetch('/api/tourplan/list');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const tourplans = data.tourplans || [];
                
                if (tourplans.length === 0) {
                    listDiv.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-info-circle"></i> Keine Tourenpläne gefunden</div>';
                    return;
                }
                
                listDiv.innerHTML = tourplans.map(tp => `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${tp.filename}</h6>
                            <small class="text-muted">
                                ${tp.customer_count} Kunden | ${tp.geocoded_count} geocodiert (${tp.geocode_rate}%)
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="geocodeSingleTourplan('${tp.filename}')">
                            <i class="fas fa-map-marker-alt"></i> Geocodieren
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                listDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Fehler: ${error.message}</div>`;
            }
        }
        
        // Geocodiere einen einzelnen Tourplan
        async function geocodeSingleTourplan(filename) {
            updateGeocodingStatus(`Geocodiere ${filename}...`, 'info');
            document.getElementById('geocoding-progress-container').style.display = 'block';
            
            try {
                const response = await fetch('/api/tourplan/geocode-file', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // Zeige Ergebnisse
                document.getElementById('geocoding-results').style.display = 'block';
                document.getElementById('geocoding-success-count').textContent = result.geocoded_count || 0;
                document.getElementById('geocoding-skip-count').textContent = result.skipped_count || 0;
                document.getElementById('geocoding-error-count').textContent = result.error_count || 0;
                document.getElementById('geocoding-total-count').textContent = result.total_customers || 0;
                
                updateGeocodingStatus(`Abgeschlossen: ${filename}`, 'success');
                
                // Lade Listen neu
                loadDBStats();
                loadAvailableTourplans();
                
            } catch (error) {
                updateGeocodingStatus(`Fehler: ${error.message}`, 'danger');
            }
        }
        
        // Geocodiere alle Tourenpläne
        async function geocodeAllTourplans() {
            if (!confirm('Wirklich ALLE Tourenpläne geocodieren? Dies kann lange dauern.')) {
                return;
            }
            
            updateGeocodingStatus('Lade Tourenpläne...', 'info');
            document.getElementById('geocoding-progress-container').style.display = 'block';
            
            try {
                const response = await fetch('/api/tourplan/list');
                const data = await response.json();
                const tourplans = data.tourplans || [];
                
                let totalSuccess = 0;
                let totalSkip = 0;
                let totalError = 0;
                let totalCustomers = 0;
                
                for (let i = 0; i < tourplans.length; i++) {
                    const tp = tourplans[i];
                    updateGeocodingStatus(`Verarbeite ${tp.filename} (${i + 1}/${tourplans.length})...`, 'info');
                    
                    try {
                        const response = await fetch('/api/tourplan/geocode-file', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({filename: tp.filename})
                        });
                        
                        const result = await response.json();
                        totalSuccess += result.geocoded_count || 0;
                        totalSkip += result.skipped_count || 0;
                        totalError += result.error_count || 0;
                        totalCustomers += result.total_customers || 0;
                        
                        // Aktualisiere Progress
                        const progress = ((i + 1) / tourplans.length) * 100;
                        updateGeocodingProgress(i + 1, tourplans.length, progress);
                        
                    } catch (error) {
                        totalError++;
                    }
                }
                
                // Zeige Ergebnisse
                document.getElementById('geocoding-results').style.display = 'block';
                document.getElementById('geocoding-success-count').textContent = totalSuccess;
                document.getElementById('geocoding-skip-count').textContent = totalSkip;
                document.getElementById('geocoding-error-count').textContent = totalError;
                document.getElementById('geocoding-total-count').textContent = totalCustomers;
                
                updateGeocodingStatus(`Abgeschlossen: ${tourplans.length} Tourenpläne verarbeitet`, 'success');
                
                // Lade Listen neu
                loadDBStats();
                loadAvailableTourplans();
                
            } catch (error) {
                updateGeocodingStatus(`Fehler: ${error.message}`, 'danger');
            }
        }
        
        // Update Geocoding Progress
        function updateGeocodingProgress(current, total, percent) {
            document.getElementById('geocoding-progress-text').textContent = `${current} / ${total}`;
            document.getElementById('geocoding-progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('geocoding-progress-bar').style.width = `${percent}%`;
        }
        
        // Update Geocoding Status
        function updateGeocodingStatus(message, type) {
            const statusDiv = document.getElementById('geocoding-status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = `<small>${message}</small>`;
        }
        
        // Lade DB-Info
        async function loadDBInfo() {
            // Prüfe ob Tab sichtbar ist
            const dbTabPane = document.getElementById('db');
            if (!dbTabPane) {
                console.warn('[DB-INFO] Tab-Pane nicht gefunden');
                return;
            }
            
            const isVisible = dbTabPane.classList.contains('show') || dbTabPane.classList.contains('active');
            console.log('[DB-INFO] Tab sichtbar:', isVisible, 'Classes:', dbTabPane.className);
            
            const contentEl = document.getElementById('db-info-content');
            if (!contentEl) {
                console.error('[DB-INFO] Element db-info-content nicht gefunden');
                return;
            }
            
            console.log('[DB-INFO] Element gefunden, setze Loading...');
            contentEl.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Lade DB-Informationen...</div>';
            
            try {
                console.log('[DB-INFO] Lade DB-Informationen...');
                const response = await fetch('/api/db/info');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[DB-INFO] Antwort erhalten:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
                const escapeHtml = (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const htmlContent = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-file"></i> Datenbank-Datei:</strong><br>
                            <code>${escapeHtml(data.db_name || 'N/A')}</code><br>
                            <small class="text-muted">${escapeHtml(data.db_path || 'N/A')}</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <strong><i class="fas fa-weight"></i> Größe:</strong><br>
                            <span class="text-primary">${data.size_mb || 0} MB</span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <strong><i class="fas fa-table"></i> Tabellen:</strong><br>
                            <span class="text-success">${data.table_count || 0}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-code-branch"></i> Schema-Version:</strong><br>
                            <span class="text-info">${escapeHtml(data.schema_version || 'N/A')}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-list"></i> Tabellen-Namen:</strong><br>
                            <small class="text-muted">${data.table_names && data.table_names.length > 0 ? data.table_names.map(t => escapeHtml(t)).join(', ') : 'Keine'}</small>
                        </div>
                    </div>
                `;
                
                console.log('[DB-INFO] Setze innerHTML, Element vorhanden:', !!contentEl);
                console.log('[DB-INFO] Element-Styles vorher:', {
                    display: window.getComputedStyle(contentEl).display,
                    visibility: window.getComputedStyle(contentEl).visibility,
                    opacity: window.getComputedStyle(contentEl).opacity,
                    height: window.getComputedStyle(contentEl).height
                });
                
                // Prüfe Parent-Elemente VOR innerHTML
                let parent = contentEl.parentElement;
                let level = 0;
                console.log('[DB-INFO] Parent-Hierarchie VOR innerHTML:');
                while (parent && level < 5) {
                    const styles = window.getComputedStyle(parent);
                    console.log(`[DB-INFO] Parent Level ${level}:`, {
                        tag: parent.tagName,
                        id: parent.id,
                        classes: parent.className,
                        display: styles.display,
                        visibility: styles.visibility,
                        opacity: styles.opacity,
                        height: styles.height,
                        overflow: styles.overflow
                    });
                    parent = parent.parentElement;
                    level++;
                }
                
                contentEl.innerHTML = htmlContent;
                
                // Force visibility auf Element UND Parent
                contentEl.style.display = 'block';
                contentEl.style.visibility = 'visible';
                contentEl.style.opacity = '1';
                
                // Prüfe und fixe Parent-Container
                let parentEl = contentEl.parentElement;
                while (parentEl && parentEl !== document.body) {
                    const styles = window.getComputedStyle(parentEl);
                    if (styles.display === 'none') {
                        console.warn('[DB-INFO] Parent hat display:none, setze block:', parentEl.tagName, parentEl.className);
                        parentEl.style.display = 'block';
                    }
                    if (styles.visibility === 'hidden') {
                        console.warn('[DB-INFO] Parent hat visibility:hidden, setze visible:', parentEl.tagName, parentEl.className);
                        parentEl.style.visibility = 'visible';
                    }
                    parentEl = parentEl.parentElement;
                }
                
                console.log('[DB-INFO] innerHTML gesetzt, Inhalt-Länge:', contentEl.innerHTML.length);
                console.log('[DB-INFO] Element-Styles nachher:', {
                    display: window.getComputedStyle(contentEl).display,
                    visibility: window.getComputedStyle(contentEl).visibility,
                    opacity: window.getComputedStyle(contentEl).opacity,
                    height: window.getComputedStyle(contentEl).height,
                    innerHTMLPreview: contentEl.innerHTML.substring(0, 100)
                });
            } catch (error) {
                console.error('[DB-INFO] Fehler:', error);
                contentEl.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Fehler: ${error.message}</div>`;
            }
        }
        
        // Lade Tabellenliste
        async function loadDBTables() {
            // Prüfe ob Tab sichtbar ist
            const dbTabPane = document.getElementById('db');
            if (!dbTabPane) {
                console.warn('[DB-TABLES] Tab-Pane nicht gefunden');
                return;
            }
            
            const isVisible = dbTabPane.classList.contains('show') || dbTabPane.classList.contains('active');
            console.log('[DB-TABLES] Tab sichtbar:', isVisible, 'Classes:', dbTabPane.className);
            
            const contentEl = document.getElementById('db-tables-content');
            if (!contentEl) {
                console.error('[DB-TABLES] Element db-tables-content nicht gefunden');
                return;
            }
            
            console.log('[DB-TABLES] Element gefunden, setze Loading...');
            contentEl.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Lade Tabellen...</div>';
            
            try {
                console.log('[DB-TABLES] Lade Tabellenliste...');
                const response = await fetch('/api/db/tables');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[DB-TABLES] Antwort erhalten:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
                const tables = data.tables || [];
                console.log(`[DB-TABLES] ${tables.length} Tabellen gefunden`);
                
                if (tables.length === 0) {
                    contentEl.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Keine Tabellen gefunden</div>';
                    return;
                }
                
                const escapeHtml = (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const tableRows = tables.map(table => {
                    const safeName = escapeHtml(table.name);
                    const rowCount = table.row_count >= 0 ? table.row_count.toLocaleString() : 'Fehler';
                    const safeNameForOnclick = safeName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                        <tr>
                            <td><code>${safeName}</code></td>
                            <td>${escapeHtml(table.description)}</td>
                            <td class="text-end"><strong>${rowCount}</strong></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="showTableDetails('${safeNameForOnclick}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                const htmlContent = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tabellenname</th>
                                    <th>Beschreibung</th>
                                    <th class="text-end">Zeilen</th>
                                    <th class="text-center">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                console.log('[DB-TABLES] Setze innerHTML, Element vorhanden:', !!contentEl);
                console.log('[DB-TABLES] Element-Styles vorher:', {
                    display: window.getComputedStyle(contentEl).display,
                    visibility: window.getComputedStyle(contentEl).visibility,
                    opacity: window.getComputedStyle(contentEl).opacity,
                    height: window.getComputedStyle(contentEl).height
                });
                
                // Prüfe Parent-Elemente VOR innerHTML
                let parent = contentEl.parentElement;
                let level = 0;
                console.log('[DB-TABLES] Parent-Hierarchie VOR innerHTML:');
                while (parent && level < 5) {
                    const styles = window.getComputedStyle(parent);
                    console.log(`[DB-TABLES] Parent Level ${level}:`, {
                        tag: parent.tagName,
                        id: parent.id,
                        classes: parent.className,
                        display: styles.display,
                        visibility: styles.visibility,
                        opacity: styles.opacity,
                        height: styles.height,
                        overflow: styles.overflow
                    });
                    parent = parent.parentElement;
                    level++;
                }
                
                contentEl.innerHTML = htmlContent;
                
                // Force visibility auf Element UND Parent
                contentEl.style.display = 'block';
                contentEl.style.visibility = 'visible';
                contentEl.style.opacity = '1';
                
                // Prüfe und fixe Parent-Container
                let parentEl = contentEl.parentElement;
                while (parentEl && parentEl !== document.body) {
                    const styles = window.getComputedStyle(parentEl);
                    if (styles.display === 'none') {
                        console.warn('[DB-TABLES] Parent hat display:none, setze block:', parentEl.tagName, parentEl.className);
                        parentEl.style.display = 'block';
                    }
                    if (styles.visibility === 'hidden') {
                        console.warn('[DB-TABLES] Parent hat visibility:hidden, setze visible:', parentEl.tagName, parentEl.className);
                        parentEl.style.visibility = 'visible';
                    }
                    parentEl = parentEl.parentElement;
                }
                
                console.log('[DB-TABLES] innerHTML gesetzt, Inhalt-Länge:', contentEl.innerHTML.length, 'Tabellen:', tables.length);
                console.log('[DB-TABLES] Element-Styles nachher:', {
                    display: window.getComputedStyle(contentEl).display,
                    visibility: window.getComputedStyle(contentEl).visibility,
                    opacity: window.getComputedStyle(contentEl).opacity,
                    height: window.getComputedStyle(contentEl).height,
                    innerHTMLPreview: contentEl.innerHTML.substring(0, 100)
                });
            } catch (error) {
                console.error('[DB-TABLES] Fehler:', error);
                contentEl.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Fehler: ${error.message}</div>`;
            }
        }
        
        // Zeige Tabellen-Details
        async function showTableDetails(tableName) {
            const card = document.getElementById('table-details-card');
            const nameEl = document.getElementById('table-details-name');
            const contentEl = document.getElementById('table-details-content');
            
            card.style.display = 'block';
            nameEl.textContent = tableName;
            contentEl.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Lade Details...</div>';
            
            // Scroll zu Details
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            try {
                const response = await fetch(`/api/db/table/${encodeURIComponent(tableName)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
                // Spalten
                const columnsHtml = data.columns.map(col => `
                    <tr>
                        <td><code>${escapeHtml(col.name)}</code></td>
                        <td>${escapeHtml(col.type)}</td>
                        <td class="text-center">${col.not_null ? '<span class="badge bg-warning">NOT NULL</span>' : ''}</td>
                        <td class="text-center">${col.primary_key ? '<span class="badge bg-primary">PK</span>' : ''}</td>
                        <td><small class="text-muted">${col.default ? escapeHtml(String(col.default)) : '-'}</small></td>
                    </tr>
                `).join('');
                
                // Indizes
                const indexesHtml = data.indexes.length > 0 ? data.indexes.map(idx => `
                    <tr>
                        <td><code>${escapeHtml(idx.name)}</code></td>
                        <td>${idx.columns.join(', ')}</td>
                        <td class="text-center">${idx.unique ? '<span class="badge bg-success">UNIQUE</span>' : ''}</td>
                    </tr>
                `).join('') : '<tr><td colspan="3" class="text-muted">Keine Indizes</td></tr>';
                
                // Vorschau
                const previewHtml = data.preview && data.preview.length > 0 ? `
                    <div class="table-responsive mt-3">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    ${Object.keys(data.preview[0]).map(key => `<th>${escapeHtml(key)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.preview.map(row => `
                                    <tr>
                                        ${Object.values(row).map(val => `<td><small>${escapeHtml(String(val || ''))}</small></td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <small class="text-muted">Zeige erste 10 Zeilen (read-only)</small>
                    </div>
                ` : '<p class="text-muted">Keine Daten verfügbar</p>';
                
                contentEl.innerHTML = `
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-columns" type="button">Spalten</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-indexes" type="button">Indizes</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-preview" type="button">Vorschau</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-columns">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Typ</th>
                                            <th class="text-center">NOT NULL</th>
                                            <th class="text-center">Primary Key</th>
                                            <th>Default</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${columnsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-indexes">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Index-Name</th>
                                            <th>Spalten</th>
                                            <th class="text-center">Unique</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${indexesHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-preview">
                            ${previewHtml}
                        </div>
                    </div>
                `;
            } catch (error) {
                contentEl.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Fehler: ${error.message}</div>`;
            }
        }
        
        // Schließe Tabellen-Details
        function closeTableDetails() {
            document.getElementById('table-details-card').style.display = 'none';
        }
        
        // Lade DB-Statistiken
        async function loadDBStats() {
            try {
                const response = await fetch('/api/db/stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('db-customers-count').textContent = data.total_customers || 0;
                document.getElementById('db-geocoded-count').textContent = data.geocoded_customers || 0;
                document.getElementById('db-missing-count').textContent = data.missing_geocodes || 0;
                document.getElementById('db-geocode-percent').textContent = `${data.geocode_rate || 0}%`;
                
            } catch (error) {
                console.error('Fehler beim Laden der DB-Statistiken:', error);
            }
        }

        // ===== DB-SCHEMA FUNKTIONEN =====
        
        async function loadDatabaseList() {
            // Prüfe ob die Elemente existieren (alte Sektion wurde entfernt)
            const container = document.getElementById('db-selection');
            const listContainer = document.getElementById('db-list-container');
            
            if (!container || !listContainer) {
                // Elemente existieren nicht mehr - Funktion überspringen (alte Sektion entfernt)
                console.log('[DB-LIST] Alte DB-Liste-Sektion nicht mehr vorhanden - überspringe');
                return;
            }
            
            try {
                const response = await fetch('/api/db/list');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.databases) {
                    container.innerHTML = '<div class="alert alert-warning">Keine Datenbanken gefunden.</div>';
                    return;
                }
                
                // Checkboxen für DB-Auswahl
                let checkboxesHtml = '<div class="row">';
                data.databases.forEach(db => {
                    const statusClass = db.status === 'online' ? 'success' : 'danger';
                    const statusIcon = db.status === 'online' ? 'check-circle' : 'times-circle';
                    const sizeText = db.size_mb ? `${db.size_mb} MB` : 'N/A';
                    
                    checkboxesHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input db-checkbox" type="checkbox" 
                                       value="${db.name}" id="db-${db.name}" 
                                       ${db.status === 'online' ? 'checked' : ''}>
                                <label class="form-check-label" for="db-${db.name}">
                                    <strong>${db.name}</strong>
                                    <span class="badge bg-${statusClass} ms-2">
                                        <i class="fas fa-${statusIcon}"></i> ${db.status}
                                    </span>
                                    <small class="text-muted d-block">${db.description || ''} (${sizeText})</small>
                                </label>
                            </div>
                        </div>
                    `;
                });
                checkboxesHtml += '</div>';
                container.innerHTML = checkboxesHtml;
                
                // Liste der Datenbanken
                let listHtml = '<div class="table-responsive"><table class="table table-sm table-hover">';
                listHtml += '<thead><tr><th>Name</th><th>Status</th><th>Größe</th><th>Beschreibung</th></tr></thead><tbody>';
                data.databases.forEach(db => {
                    const statusClass = db.status === 'online' ? 'success' : 'danger';
                    const sizeText = db.size_mb ? `${db.size_mb} MB` : 'N/A';
                    listHtml += `
                        <tr>
                            <td><strong>${db.name}</strong></td>
                            <td><span class="badge bg-${statusClass}">${db.status}</span></td>
                            <td>${sizeText}</td>
                            <td><small>${db.description || ''}</small></td>
                        </tr>
                    `;
                });
                listHtml += '</tbody></table></div>';
                listContainer.innerHTML = listHtml;
                
            } catch (error) {
                console.error('Fehler beim Laden der Datenbank-Liste:', error);
                const container = document.getElementById('db-selection');
                if (container) {
                    container.innerHTML = `<div class="alert alert-danger">Fehler: ${error.message}</div>`;
                }
            }
        }

        async function loadSelectedSchemas() {
            const checkboxes = document.querySelectorAll('.db-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Bitte wählen Sie mindestens eine Datenbank aus.');
                return;
            }
            
            const selectedDbs = Array.from(checkboxes).map(cb => cb.value).join(',');
            
            try {
                const response = await fetch(`/api/db/schemas?dbs=${encodeURIComponent(selectedDbs)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const schemaCard = document.getElementById('schema-view-card');
                const schemaContent = document.getElementById('schema-content');
                
                if (!data.success || !data.schemas) {
                    schemaContent.innerHTML = '<div class="alert alert-warning">Keine Schema-Informationen verfügbar.</div>';
                    schemaCard.style.display = 'block';
                    return;
                }
                
                let html = '';
                Object.entries(data.schemas).forEach(([dbName, schema]) => {
                    if (schema.error) {
                        html += `
                            <div class="alert alert-warning mb-3">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${dbName}</h6>
                                <p class="mb-0">Fehler: ${schema.error}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-database"></i> ${dbName}
                                    <span class="badge bg-light text-dark ms-2">${schema.table_count || 0} Tabellen</span>
                                    <span class="badge bg-light text-dark ms-2">${schema.size_mb || 0} MB</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted"><small>${schema.description || ''}</small></p>
                                <div class="accordion" id="accordion-${dbName.replace(/[^a-zA-Z0-9]/g, '-')}">
                    `;
                    
                    if (schema.tables && schema.tables.length > 0) {
                        schema.tables.forEach((table, idx) => {
                            const accordionId = `accordion-${dbName.replace(/[^a-zA-Z0-9]/g, '-')}-${idx}`;
                            html += `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-${accordionId}">
                                        <button class="accordion-button ${idx === 0 ? '' : 'collapsed'}" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse-${accordionId}">
                                            <i class="fas fa-table"></i> ${table.name}
                                            <span class="badge bg-secondary ms-2">${table.column_count || 0} Spalten</span>
                                            ${table.row_count !== null ? `<span class="badge bg-info ms-2">${table.row_count} Zeilen</span>` : ''}
                                        </button>
                                    </h2>
                                    <div id="collapse-${accordionId}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" 
                                         data-bs-parent="#accordion-${dbName.replace(/[^a-zA-Z0-9]/g, '-')}">
                                        <div class="accordion-body">
                            `;
                            
                            // Spalten
                            if (table.columns && table.columns.length > 0) {
                                html += '<h6>Spalten:</h6><div class="table-responsive"><table class="table table-sm table-bordered">';
                                html += '<thead><tr><th>Name</th><th>Typ</th><th>NOT NULL</th><th>Default</th><th>PK</th></tr></thead><tbody>';
                                table.columns.forEach(col => {
                                    html += `
                                        <tr>
                                            <td><strong>${col.name}</strong></td>
                                            <td><code>${col.type}</code></td>
                                            <td>${col.notnull ? '<span class="badge bg-warning">Ja</span>' : '<span class="badge bg-secondary">Nein</span>'}</td>
                                            <td>${col.default_value || '<em>kein</em>'}</td>
                                            <td>${col.pk ? '<span class="badge bg-primary">PK</span>' : ''}</td>
                                        </tr>
                                    `;
                                });
                                html += '</tbody></table></div>';
                            }
                            
                            // Indizes
                            if (table.indexes && table.indexes.length > 0) {
                                html += '<h6 class="mt-3">Indizes:</h6><ul class="list-group">';
                                table.indexes.forEach(idx => {
                                    html += `
                                        <li class="list-group-item">
                                            <strong>${idx.name}</strong>
                                            ${idx.unique ? '<span class="badge bg-success ms-2">UNIQUE</span>' : ''}
                                            <small class="text-muted d-block">Spalten: ${idx.columns.join(', ')}</small>
                                        </li>
                                    `;
                                });
                                html += '</ul>';
                            }
                            
                            if (table.error) {
                                html += `<div class="alert alert-danger">Fehler: ${table.error}</div>`;
                            }
                            
                            html += `
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p class="text-muted">Keine Tabellen gefunden.</p>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                schemaContent.innerHTML = html;
                schemaCard.style.display = 'block';
                
                // Scroll zu Schema-Ansicht
                schemaCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('Fehler beim Laden der Schemas:', error);
                document.getElementById('schema-content').innerHTML = 
                    `<div class="alert alert-danger">Fehler: ${error.message}</div>`;
                document.getElementById('schema-view-card').style.display = 'block';
            }
        }

        // ===== KI-INTEGRATION FUNKTIONEN =====
        

        // Lade DB-Liste beim Öffnen des Tabs (nur wenn alte Sektion vorhanden)
        // Diese Funktion wird nicht mehr benötigt, da wir die neue DB-Verwaltung haben
        // Die loadDatabaseList() Funktion prüft selbst, ob die Elemente existieren

        // ===== BENUTZERVERWALTUNG FUNKTIONEN =====
        
        function showUsersTab(event) {
            // Verstecke alle Tab-Panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.style.display = 'none';
            });
            
            // Zeige Benutzerverwaltung Tab
            const usersTab = document.getElementById('users');
            if (usersTab) {
                usersTab.style.display = 'block';
                loadUsers();
            } else {
                console.error('[USERS] Tab mit id="users" nicht gefunden!');
                alert('Fehler: Benutzerverwaltungs-Tab nicht gefunden. Bitte Seite neu laden.');
                return;
            }
            
            // Aktiviere Navigation-Item
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.target) {
                event.target.closest('.admin-nav-item')?.classList.add('active');
            } else {
                // Fallback: Finde den Link manuell
                document.querySelectorAll('.admin-nav-item').forEach(item => {
                    if (item.textContent.includes('Benutzerverwaltung')) {
                        item.classList.add('active');
                    }
                });
            }
        }

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    if (response.status === 403) {
                        showUsersAlert('Sie haben keine Berechtigung für die Benutzerverwaltung.', 'danger');
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Zugriff verweigert</td></tr>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const users = data.users || [];
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Keine Benutzer gefunden</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${escapeHtml(user.username)}</strong></td>
                        <td>
                            <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">
                                ${escapeHtml(user.role)}
                            </span>
                        </td>
                        <td>${user.email ? escapeHtml(user.email) : '-'}</td>
                        <td>${user.full_name ? escapeHtml(user.full_name) : '-'}</td>
                        <td>
                            <span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">
                                ${user.active ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString('de-DE') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})" title="Bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="changeUserPassword(${user.id})" title="Passwort ändern">
                                <i class="fas fa-key"></i>
                            </button>
                            ${user.active ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUserConfirm(${user.id}, '${escapeHtml(user.username)}')" title="Löschen">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Fehler: ${error.message}</td></tr>`;
            }
        }

        function showCreateUserForm() {
            document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Neuer Benutzer';
            document.getElementById('userForm').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('password-fields').style.display = 'block';
            document.getElementById('user-active-field').style.display = 'none';
            document.getElementById('user-password').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        async function editUser(userId) {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);
                
                if (!user) {
                    showUsersAlert('Benutzer nicht gefunden.', 'danger');
                    return;
                }
                
                document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit"></i> Benutzer bearbeiten';
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-username').readOnly = true;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-fullname').value = user.full_name || '';
                document.getElementById('user-active').checked = user.active;
                document.getElementById('password-fields').style.display = 'none';
                document.getElementById('user-active-field').style.display = 'block';
                document.getElementById('user-password').required = false;
                
                const modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();
                
            } catch (error) {
                console.error('Fehler beim Laden des Benutzers:', error);
                showUsersAlert('Fehler beim Laden des Benutzers.', 'danger');
            }
        }

        async function saveUser() {
            const form = document.getElementById('userForm');
            const userId = document.getElementById('user-id').value;
            const formData = new FormData(form);
            
            const userData = {
                username: formData.get('username'),
                role: formData.get('role'),
                email: formData.get('email') || null,
                full_name: formData.get('full_name') || null
            };
            
            if (userId) {
                // Update
                userData.active = document.getElementById('user-active').checked;
                
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Fehler beim Aktualisieren');
                    }
                    
                    showUsersAlert('Benutzer erfolgreich aktualisiert.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                } catch (error) {
                    showUsersAlert(`Fehler: ${error.message}`, 'danger');
                }
            } else {
                // Create
                userData.password = formData.get('password');
                
                if (!userData.password || userData.password.length < 8) {
                    showUsersAlert('Passwort muss mindestens 8 Zeichen lang sein.', 'danger');
                    return;
                }
                
                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Fehler beim Erstellen');
                    }
                    
                    showUsersAlert('Benutzer erfolgreich erstellt.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                } catch (error) {
                    showUsersAlert(`Fehler: ${error.message}`, 'danger');
                }
            }
        }

        function changeUserPassword(userId) {
            document.getElementById('password-user-id').value = userId;
            document.getElementById('passwordForm').reset();
            
            const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
            modal.show();
        }

        async function savePassword() {
            const userId = document.getElementById('password-user-id').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!newPassword || newPassword.length < 8) {
                showUsersAlert('Passwort muss mindestens 8 Zeichen lang sein.', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}/password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Fehler beim Ändern des Passworts');
                }
                
                showUsersAlert('Passwort erfolgreich geändert.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
            } catch (error) {
                showUsersAlert(`Fehler: ${error.message}`, 'danger');
            }
        }

        async function deleteUserConfirm(userId, username) {
            if (!confirm(`Möchten Sie den Benutzer "${username}" wirklich löschen?\n\nDer Benutzer wird deaktiviert und kann nicht mehr einloggen.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Fehler beim Löschen');
                }
                
                showUsersAlert('Benutzer erfolgreich gelöscht.', 'success');
                loadUsers();
            } catch (error) {
                showUsersAlert(`Fehler: ${error.message}`, 'danger');
            }
        }

        function showUsersAlert(message, type) {
            const container = document.getElementById('users-alert-container');
            if (!container) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // AR-05: Geocoding-Fehler Tab Funktionen
        function showGeocodeFailuresTab(event) {
            if (event) event.preventDefault();
            // Verstecke alle Tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('show', 'active');
            });
            // Entferne active von allen Nav-Items
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Zeige Geocoding-Fehler Tab
            const failuresTab = document.getElementById('geocode-failures');
            if (failuresTab) {
                failuresTab.style.display = 'block';
                failuresTab.classList.add('show', 'active');
            }
            // Setze active auf Nav-Item
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            // Lade Fehler-Liste
            loadGeocodeFailures();
        }
        
        async function loadGeocodeFailures() {
            const loadingEl = document.getElementById('geocode-failures-loading');
            const contentEl = document.getElementById('geocode-failures-content');
            const errorEl = document.getElementById('geocode-failures-error');
            const tableBody = document.getElementById('geocode-failures-table-body');
            
            if (!loadingEl || !contentEl || !errorEl || !tableBody) {
                console.error('[GEOCODE-FAILURES] Tab-Elemente nicht gefunden');
                return;
            }
            
            const reason = document.getElementById('geocode-filter-reason')?.value || '';
            const search = document.getElementById('geocode-filter-search')?.value || '';
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            
            try {
                let url = '/api/geocode/fail-cache?limit=200&active_only=false';
                if (reason) url += `&reason=${encodeURIComponent(reason)}`;
                if (search) url += `&q=${encodeURIComponent(search)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Tabelle befüllen
                tableBody.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // TTL-Badge
                        let ttlBadge = '';
                        if (item.ttl_min !== null && item.ttl_min > 0) {
                            const hours = Math.floor(item.ttl_min / 60);
                            const mins = item.ttl_min % 60;
                            ttlBadge = `<span class="badge bg-warning">${hours}h ${mins}m</span>`;
                        } else if (item.ttl_min === 0) {
                            ttlBadge = '<span class="badge bg-success">Bereit</span>';
                        } else {
                            ttlBadge = '<span class="badge bg-secondary">Unbekannt</span>';
                        }
                        
                        const addressEscaped = escapeHtml(item.address || '-');
                        row.innerHTML = `
                            <td>${addressEscaped}</td>
                            <td><span class="badge bg-danger">${escapeHtml(item.reason || 'Unbekannt')}</span></td>
                            <td>-</td>
                            <td>${ttlBadge} ${item.until ? '<br><small class="text-muted">' + escapeHtml(item.until) + '</small>' : ''}</td>
                            <td><small class="text-muted">${escapeHtml(item.updated_at || '-')}</small></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="retryGeocode('${addressEscaped.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-redo"></i> Erneut versuchen
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGeocodeFailure('${addressEscaped.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash"></i> Löschen
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Keine Fehler gefunden</td></tr>';
                }
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                loadingEl.style.display = 'none';
                errorEl.textContent = `Fehler beim Laden: ${e.message}`;
                errorEl.style.display = 'block';
            }
        }
        
        async function retryGeocode(address) {
            if (!confirm(`Möchten Sie die Geocodierung für "${address}" erneut versuchen?`)) {
                return;
            }
            
            try {
                // TODO: API-Endpoint für Retry erstellen
                alert('Retry-Funktion wird noch implementiert');
                loadGeocodeFailures();
            } catch (error) {
                alert(`Fehler: ${error.message}`);
            }
        }
        
        async function deleteGeocodeFailure(address) {
            if (!confirm(`Möchten Sie den Fehler-Eintrag für "${address}" wirklich löschen?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/geocode/fail-cache/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: address })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                alert('Fehler-Eintrag gelöscht');
                loadGeocodeFailures();
            } catch (error) {
                alert(`Fehler beim Löschen: ${error.message}`);
            }
        }
        
        async function clearAllGeocodeFailures() {
            if (!confirm('Möchten Sie ALLE Geocoding-Fehler-Einträge wirklich löschen?\n\nDiese Aktion kann nicht rückgängig gemacht werden!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/geocode/fail-cache/clear-all', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                alert('Alle Fehler-Einträge gelöscht');
                loadGeocodeFailures();
            } catch (error) {
                alert(`Fehler beim Löschen: ${error.message}`);
            }
        }
    </script>
    </div> <!-- Ende adminContent -->
</body>
</html>

